#!/bin/bash

# Script to install security tools (nmap, masscan, etc.) in a compromised container
# This simulates an attacker installing tools after initial compromise

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

NAMESPACE="${1:-vulnerable-apps}"
POD_NAME="${2:-}"

if [ -z "$POD_NAME" ]; then
    echo -e "${YELLOW}Usage: $0 <namespace> <pod-name>${NC}"
    echo -e "${YELLOW}Example: $0 vulnerable-apps vulnerable-api-78b4b96874-sdv6x${NC}"
    exit 1
fi

echo -e "${BLUE}=== Installing Security Tools in Container ===${NC}"
echo -e "${GREEN}Pod: $POD_NAME${NC}"
echo -e "${GREEN}Namespace: $NAMESPACE${NC}\n"

# Detect container OS
echo -e "${YELLOW}[1] Detecting container OS...${NC}"
OS_TYPE=$(kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "cat /etc/os-release 2>/dev/null | grep ^ID= | cut -d= -f2 | tr -d '\"' || echo 'unknown'" 2>/dev/null || echo "unknown")
echo -e "${GREEN}OS Type: $OS_TYPE${NC}"

# Install tools based on OS
if [ "$OS_TYPE" = "alpine" ] || [ "$OS_TYPE" = "alpinelinux" ]; then
    echo -e "\n${YELLOW}[2] Installing tools on Alpine Linux...${NC}"
    kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
        apk update && \
        apk add --no-cache nmap nmap-scripts masscan netcat-openbsd curl wget tcpdump bind-tools iputils 2>&1 | tail -5
    " || echo -e "${RED}✗ Failed to install tools${NC}"
elif [ "$OS_TYPE" = "debian" ] || [ "$OS_TYPE" = "ubuntu" ]; then
    echo -e "\n${YELLOW}[2] Installing tools on Debian/Ubuntu...${NC}"
    kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
        export DEBIAN_FRONTEND=noninteractive && \
        apt-get update -qq && \
        apt-get install -y -qq nmap masscan netcat-openbsd curl wget tcpdump dnsutils iputils-ping 2>&1 | tail -5
    " || echo -e "${RED}✗ Failed to install tools${NC}"
else
    echo -e "\n${YELLOW}[2] Attempting generic installation...${NC}"
    # Try to install nmap using available package manager
    kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
        (command -v apk && apk add --no-cache nmap) || \
        (command -v apt-get && apt-get update -qq && apt-get install -y -qq nmap) || \
        (command -v yum && yum install -y -q nmap) || \
        echo 'Could not install nmap automatically'
    " || echo -e "${RED}✗ Failed to install tools${NC}"
fi

# Verify installation
echo -e "\n${YELLOW}[3] Verifying installed tools...${NC}"
kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
    echo '=== Installed Tools ===' && \
    (command -v nmap && nmap --version | head -1) || echo 'nmap: not found' && \
    (command -v nc && echo 'netcat: installed') || echo 'netcat: not found' && \
    (command -v curl && curl --version | head -1) || echo 'curl: not found' && \
    (command -v ping && echo 'ping: installed') || echo 'ping: not found'
"

echo -e "\n${GREEN}=== Tools Installation Complete ===${NC}"
echo -e "${YELLOW}You can now use these tools to scan the cluster from inside${NC}"

