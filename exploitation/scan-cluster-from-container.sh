#!/bin/bash

# Script to scan the Kubernetes cluster network from inside a compromised container
# Uses nmap and other tools to discover services and hosts

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

NAMESPACE="${1:-vulnerable-apps}"
POD_NAME="${2:-}"

if [ -z "$POD_NAME" ]; then
    echo -e "${YELLOW}Usage: $0 <namespace> <pod-name>${NC}"
    echo -e "${YELLOW}Example: $0 vulnerable-apps vulnerable-api-78b4b96874-sdv6x${NC}"
    exit 1
fi

echo -e "${BLUE}=== Scanning Cluster from Compromised Container ===${NC}"
echo -e "${GREEN}Pod: $POD_NAME${NC}"
echo -e "${GREEN}Namespace: $NAMESPACE${NC}\n"

# Get pod IP and network info
echo -e "${YELLOW}[1] Gathering network information...${NC}"
POD_IP=$(kubectl get pod -n "$NAMESPACE" "$POD_NAME" -o jsonpath='{.status.podIP}')
NODE_IP=$(kubectl get pod -n "$NAMESPACE" "$POD_NAME" -o jsonpath='{.status.hostIP}')

echo -e "${GREEN}Pod IP: $POD_IP${NC}"
echo -e "${GREEN}Node IP: $NODE_IP${NC}"

# Get network CIDR (common Kubernetes ranges)
kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
    echo '=== Network Configuration ===' && \
    ip addr show | grep 'inet ' && \
    echo '' && \
    ip route show | head -5
"

# Scan local network (pod CIDR)
echo -e "\n${YELLOW}[2] Scanning local pod network...${NC}"
POD_CIDR=$(kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "ip route | grep -v default | head -1 | awk '{print \$1}'" 2>/dev/null || echo "10.1.0.0/16")
echo -e "${GREEN}Pod CIDR: $POD_CIDR${NC}"

kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
    if command -v nmap > /dev/null; then
        echo 'Scanning common Kubernetes ports...' && \
        nmap -sn $POD_CIDR 2>/dev/null | grep -E 'Nmap scan report|Host is up' | head -20 || \
        echo 'Quick scan:'
        nmap -p 22,80,443,3306,5000,8080,8443,10250,10255 --open $POD_CIDR 2>/dev/null | grep -E 'Nmap scan|PORT|open' | head -30
    else
        echo 'nmap not available, using ping scan...'
        for i in \$(seq 1 254); do
            ip=\$(echo $POD_CIDR | cut -d. -f1-3).\$i
            if ping -c 1 -W 1 \$ip > /dev/null 2>&1; then
                echo \"Host \$ip is up\"
            fi
        done | head -20
    fi
"

# Scan Kubernetes services
echo -e "\n${YELLOW}[3] Discovering Kubernetes services...${NC}"
kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
    echo '=== Service Discovery ===' && \
    nslookup kubernetes.default.svc.cluster.local 2>/dev/null || echo 'DNS not available' && \
    echo '' && \
    echo 'Scanning common Kubernetes service IPs...' && \
    for svc in \$(kubectl get svc -n $NAMESPACE -o jsonpath='{.items[*].spec.clusterIP}' 2>/dev/null); do
        if [ -n \"\$svc\" ] && [ \"\$svc\" != 'None' ]; then
            echo \"Service IP: \$svc\"
            if command -v nc > /dev/null; then
                for port in 80 443 3306 5000 8080; do
                    if timeout 1 nc -zv \$svc \$port 2>&1 | grep -q succeeded; then
                        echo \"  Port \$port: OPEN\"
                    fi
                done
            fi
        fi
    done
"

# Scan node network
echo -e "\n${YELLOW}[4] Scanning node network...${NC}"
NODE_CIDR=$(echo "$NODE_IP" | cut -d. -f1-3).0/24
echo -e "${GREEN}Node CIDR: $NODE_CIDR${NC}"

kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
    if command -v nmap > /dev/null; then
        echo 'Scanning node network for Kubernetes ports...' && \
        nmap -p 10250,10255,30000-32767 --open $NODE_CIDR 2>/dev/null | grep -E 'Nmap scan|PORT|open' | head -20
    else
        echo 'nmap not available for node scan'
    fi
"

# Discover other pods
echo -e "\n${YELLOW}[5] Discovering other pods in cluster...${NC}"
kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
    echo '=== Pod Discovery ===' && \
    for pod in \$(kubectl get pods -n $NAMESPACE -o jsonpath='{.items[*].status.podIP}' 2>/dev/null); do
        if [ -n \"\$pod\" ] && [ \"\$pod\" != '$POD_IP' ]; then
            echo \"Found pod IP: \$pod\"
            if command -v nc > /dev/null; then
                for port in 80 443 3000 3306 5000 8080; do
                    if timeout 1 nc -zv \$pod \$port 2>&1 | grep -q succeeded; then
                        echo \"  Port \$port: OPEN\"
                    fi
                done
            fi
        fi
    done
"

# Check for exposed secrets/configmaps via environment
echo -e "\n${YELLOW}[6] Checking for exposed secrets in environment...${NC}"
kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
    echo '=== Environment Variables ===' && \
    env | grep -iE 'secret|password|token|key|credential' | head -10 || echo 'No obvious secrets in env'
"

echo -e "\n${GREEN}=== Cluster Scan Complete ===${NC}"
echo -e "${YELLOW}Review the output above for discovered services and hosts${NC}"

