#!/bin/bash

# Script for lateral movement from bastion to Kubernetes cluster

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}=== Lateral Movement: Bastion -> Kubernetes Cluster ===${NC}\n"

# Verify we are on the bastion or have access
if [ -z "$AWS_REGION" ]; then
    echo -e "${YELLOW}Getting AWS region...${NC}"
    export AWS_REGION=$(aws configure get region || echo "us-east-1")
fi

if [ -z "$CLUSTER_NAME" ]; then
    export CLUSTER_NAME="lab-cluster"
    echo -e "${YELLOW}Using cluster: $CLUSTER_NAME${NC}"
fi

# 1. Configure kubectl
echo -e "${YELLOW}[1] Configuring EKS cluster access...${NC}"
aws eks update-kubeconfig --region "$AWS_REGION" --name "$CLUSTER_NAME" 2>/dev/null && \
    echo -e "${GREEN}✓ kubectl configured${NC}" || \
    { echo -e "${RED}✗ Error configuring kubectl${NC}"; exit 1; }

# 2. Verify cluster access
echo -e "\n${YELLOW}[2] Verifying cluster access...${NC}"
kubectl cluster-info && \
    echo -e "${GREEN}✓ Cluster access verified${NC}" || \
    { echo -e "${RED}✗ Cannot access cluster${NC}"; exit 1; }

# 3. Enumerate namespaces
echo -e "\n${YELLOW}[3] Enumerating namespaces...${NC}"
kubectl get namespaces
echo -e "${GREEN}✓ Namespaces enumerated${NC}"

# 4. Enumerate pods
echo -e "\n${YELLOW}[4] Enumerating pods in all namespaces...${NC}"
kubectl get pods --all-namespaces
echo -e "${GREEN}✓ Pods enumerated${NC}"

# 5. Enumerate services
echo -e "\n${YELLOW}[5] Enumerating services...${NC}"
kubectl get services --all-namespaces
echo -e "${GREEN}✓ Services enumerated${NC}"

# 6. Search for secrets
echo -e "\n${YELLOW}[6] Searching for secrets...${NC}"
kubectl get secrets --all-namespaces
echo -e "${GREEN}✓ Secrets enumerated${NC}"

# 7. Search for configmaps
echo -e "\n${YELLOW}[7] Searching for configmaps...${NC}"
kubectl get configmaps --all-namespaces
echo -e "${GREEN}✓ ConfigMaps enumerated${NC}"

# 8. Verify user permissions
echo -e "\n${YELLOW}[8] Verifying permissions...${NC}"
kubectl auth can-i --list
echo -e "${GREEN}✓ Permissions verified${NC}"

# 9. Search for pods with elevated privileges
echo -e "\n${YELLOW}[9] Searching for pods with privileged security context...${NC}"
kubectl get pods --all-namespaces -o json | \
    jq -r '.items[] | select(.spec.containers[].securityContext.privileged == true) | "\(.metadata.namespace)/\(.metadata.name)"' 2>/dev/null || \
    echo -e "${YELLOW}   jq not available, searching manually...${NC}"
echo -e "${GREEN}✓ Privileged pods identified${NC}"

# 10. Search for sensitive volume mounts
echo -e "\n${YELLOW}[10] Searching for sensitive volume mounts...${NC}"
kubectl get pods --all-namespaces -o json | \
    jq -r '.items[] | select(.spec.volumes[]?.hostPath.path) | "\(.metadata.namespace)/\(.metadata.name): \(.spec.volumes[].hostPath.path)"' 2>/dev/null || \
    echo -e "${YELLOW}   Review pods manually${NC}"

echo -e "\n${BLUE}=== Lateral Movement Completed ===${NC}"
