#!/bin/bash

# Script para movimiento lateral desde el bastión al cluster Kubernetes

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}=== Movimiento Lateral: Bastión -> Kubernetes Cluster ===${NC}\n"

# Verificar que estamos en el bastión o tenemos acceso
if [ -z "$AWS_REGION" ]; then
    echo -e "${YELLOW}Obteniendo región de AWS...${NC}"
    export AWS_REGION=$(aws configure get region || echo "us-east-1")
fi

if [ -z "$CLUSTER_NAME" ]; then
    export CLUSTER_NAME="lab-cluster"
    echo -e "${YELLOW}Usando cluster: $CLUSTER_NAME${NC}"
fi

# 1. Configurar kubectl
echo -e "${YELLOW}[1] Configurando acceso al cluster EKS...${NC}"
aws eks update-kubeconfig --region "$AWS_REGION" --name "$CLUSTER_NAME" 2>/dev/null && \
    echo -e "${GREEN}✓ kubectl configurado${NC}" || \
    { echo -e "${RED}✗ Error configurando kubectl${NC}"; exit 1; }

# 2. Verificar acceso al cluster
echo -e "\n${YELLOW}[2] Verificando acceso al cluster...${NC}"
kubectl cluster-info && \
    echo -e "${GREEN}✓ Acceso al cluster verificado${NC}" || \
    { echo -e "${RED}✗ No se puede acceder al cluster${NC}"; exit 1; }

# 3. Enumerar namespaces
echo -e "\n${YELLOW}[3] Enumerando namespaces...${NC}"
kubectl get namespaces
echo -e "${GREEN}✓ Namespaces enumerados${NC}"

# 4. Enumerar pods
echo -e "\n${YELLOW}[4] Enumerando pods en todos los namespaces...${NC}"
kubectl get pods --all-namespaces
echo -e "${GREEN}✓ Pods enumerados${NC}"

# 5. Enumerar servicios
echo -e "\n${YELLOW}[5] Enumerando servicios...${NC}"
kubectl get services --all-namespaces
echo -e "${GREEN}✓ Servicios enumerados${NC}"

# 6. Buscar secretos
echo -e "\n${YELLOW}[6] Buscando secretos...${NC}"
kubectl get secrets --all-namespaces
echo -e "${GREEN}✓ Secretos enumerados${NC}"

# 7. Buscar configmaps
echo -e "\n${YELLOW}[7] Buscando configmaps...${NC}"
kubectl get configmaps --all-namespaces
echo -e "${GREEN}✓ ConfigMaps enumerados${NC}"

# 8. Verificar permisos del usuario
echo -e "\n${YELLOW}[8] Verificando permisos...${NC}"
kubectl auth can-i --list
echo -e "${GREEN}✓ Permisos verificados${NC}"

# 9. Buscar pods con privilegios elevados
echo -e "\n${YELLOW}[9] Buscando pods con security context privilegiado...${NC}"
kubectl get pods --all-namespaces -o json | \
    jq -r '.items[] | select(.spec.containers[].securityContext.privileged == true) | "\(.metadata.namespace)/\(.metadata.name)"' 2>/dev/null || \
    echo -e "${YELLOW}   jq no disponible, buscando manualmente...${NC}"
echo -e "${GREEN}✓ Pods privilegiados identificados${NC}"

# 10. Buscar montajes de volumen sensibles
echo -e "\n${YELLOW}[10] Buscando montajes de volumen sensibles...${NC}"
kubectl get pods --all-namespaces -o json | \
    jq -r '.items[] | select(.spec.volumes[]?.hostPath.path) | "\(.metadata.namespace)/\(.metadata.name): \(.spec.volumes[].hostPath.path)"' 2>/dev/null || \
    echo -e "${YELLOW}   Revisar manualmente los pods${NC}"

echo -e "\n${BLUE}=== Movimiento Lateral Completado ===${NC}"

