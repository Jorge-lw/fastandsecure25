#!/bin/bash

# Script to enumerate resources in Kubernetes cluster

set -eo pipefail

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}=== Kubernetes Resource Enumeration ===${NC}\n"

# 1. Cluster information
echo -e "${YELLOW}[1] Cluster information...${NC}"
kubectl cluster-info
echo ""

# 2. Kubernetes version
echo -e "${YELLOW}[2] Kubernetes version...${NC}"
kubectl version --client --short 2>/dev/null || kubectl version --client 2>/dev/null || echo "Version info not available"
echo ""

# 3. Nodes
echo -e "${YELLOW}[3] Cluster nodes...${NC}"
kubectl get nodes -o wide
echo ""

# 4. Namespaces
echo -e "${YELLOW}[4] Namespaces...${NC}"
kubectl get namespaces
echo ""

# 5. All pods
echo -e "${YELLOW}[5] All pods...${NC}"
kubectl get pods --all-namespaces -o wide
echo ""

# 6. Services
echo -e "${YELLOW}[6] Services...${NC}"
kubectl get services --all-namespaces
echo ""

# 7. Deployments
echo -e "${YELLOW}[7] Deployments...${NC}"
kubectl get deployments --all-namespaces
echo ""

# 8. StatefulSets
echo -e "${YELLOW}[8] StatefulSets...${NC}"
kubectl get statefulsets --all-namespaces
echo ""

# 9. DaemonSets
echo -e "${YELLOW}[9] DaemonSets...${NC}"
kubectl get daemonsets --all-namespaces
echo ""

# 10. ConfigMaps
echo -e "${YELLOW}[10] ConfigMaps...${NC}"
kubectl get configmaps --all-namespaces
echo ""

# 11. Secrets
echo -e "${YELLOW}[11] Secrets...${NC}"
kubectl get secrets --all-namespaces
echo ""

# 12. ServiceAccounts
echo -e "${YELLOW}[12] ServiceAccounts...${NC}"
kubectl get serviceaccounts --all-namespaces
echo ""

# 13. Roles and RoleBindings
echo -e "${YELLOW}[13] Roles...${NC}"
kubectl get roles --all-namespaces
echo ""
echo -e "${YELLOW}[14] RoleBindings...${NC}"
kubectl get rolebindings --all-namespaces
echo ""

# 14. ClusterRoles and ClusterRoleBindings
echo -e "${YELLOW}[15] ClusterRoles...${NC}"
kubectl get clusterroles
echo ""
echo -e "${YELLOW}[16] ClusterRoleBindings...${NC}"
kubectl get clusterrolebindings
echo ""

# 15. Ingress
echo -e "${YELLOW}[17] Ingress...${NC}"
kubectl get ingress --all-namespaces
echo ""

# 16. PersistentVolumes
echo -e "${YELLOW}[18] PersistentVolumes...${NC}"
kubectl get pv
echo ""

# 17. PersistentVolumeClaims
echo -e "${YELLOW}[19] PersistentVolumeClaims...${NC}"
kubectl get pvc --all-namespaces
echo ""

# 18. NetworkPolicies
echo -e "${YELLOW}[20] NetworkPolicies...${NC}"
kubectl get networkpolicies --all-namespaces
echo ""

# 19. Pods with vulnerable images
echo -e "${YELLOW}[21] Searching for pods with vulnerable images...${NC}"
kubectl get pods --all-namespaces -o json | \
    jq -r '.items[] | select(.spec.containers[].image | contains("vulnerable")) | "\(.metadata.namespace)/\(.metadata.name): \(.spec.containers[].image)"' 2>/dev/null || \
    echo -e "${YELLOW}   jq not available${NC}"
echo ""

# 20. Pods with privileged security context
echo -e "${YELLOW}[22] Searching for pods with privileged security context...${NC}"
kubectl get pods --all-namespaces -o json | \
    jq -r '.items[] | select(.spec.containers[].securityContext.privileged == true) | "\(.metadata.namespace)/\(.metadata.name)"' 2>/dev/null || \
    echo -e "${YELLOW}   Review manually${NC}"
echo ""

echo -e "${GREEN}=== Enumeration Completed ===${NC}"
